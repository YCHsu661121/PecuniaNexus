<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§é¸è‚¡é«˜æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .app-version {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .search-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            margin-bottom: 30px;
            border: 1px solid #2d2d44;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-input {
            flex: 0 0 220px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            outline: none;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .auth-panel {
            background: #252538;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            max-width: 400px;
            margin: 0 auto 20px;
            border: 1px solid #3a3a52;
        }

        .auth-panel h3 {
            margin-bottom: 15px;
            color: #c0c0c0;
        }

        .auth-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .auth-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 127, 199, 0.5);
        }

        .admin-badge {
            display: inline-block;
            background: #e85d75;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        /* Scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a6fa5;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a7fc7;
        }

        .lang-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            padding: 8px 16px;
            background: #2a2a3e;
            border: 2px solid #5a7fc7;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #5a7fc7;
        }

        .lang-btn.active {
            background: #5a7fc7;
            color: white;
        }

        .lang-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 199, 0.5);
        }

        .search-input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .search-input:focus {
            border-color: #5a7fc7;
            box-shadow: 0 0 0 3px rgba(90, 127, 199, 0.3);
        }

        .search-btn {
            padding: 15px 30px;
            font-size: 16px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 127, 199, 0.5);
        }

        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stock-tag {
            padding: 8px 15px;
            background: #2a2a3e;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #7a9fd7;
            border: 1px solid #3a3a52;
        }

        .stock-tag:hover {
            background: #5a7fc7;
            color: white;
            transform: scale(1.05);
        }

        .result-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: none;
            border: 1px solid #2d2d44;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stock-info {
            margin-bottom: 30px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .stock-title {
            font-size: 1.5em;
            color: #e0e0e0;
        }

        .stock-code {
            color: #999;
            font-size: 0.75em;
        }

        .price-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-card {
            padding: 20px;
            background: #2a2a3e;
            border-radius: 10px;
            border-left: 4px solid #5a7fc7;
        }

        .price-label {
            color: #999;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .price-value.up {
            color: #e74c3c;
        }

        .price-value.down {
            color: #27ae60;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3a3a52;
            color: #e0e0e0;
            font-size: 0.85em;
        }

        .history-table th {
            background: #4a6fa5;
            color: white;
            font-weight: bold;
        }

        .history-table tr:hover {
            background: #2a2a3e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            padding: 20px;
            background: #3a1f1f;
            border-left: 4px solid #e85d75;
            border-radius: 5px;
            color: #ff8a9a;
        }

        .update-time {
            text-align: right;
            color: #999;
            font-size: 0.85em;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a52;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #5a7fc7;
        }

        .tab.active {
            color: #5a7fc7;
            border-bottom-color: #5a7fc7;
        } show">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">ğŸ“Š æŸ¥è©¢è‚¡ç¥¨</button>
                <button class="tab" onclick="switchTab('watchlist')">â­ é—œæ³¨æ¸…å–®</button>
                <button class="tab" onclick="switchTab('history')">ğŸ• æŸ¥è©¢æ­·å²</button>
            </div>

            <div id="searchTab" class="tab-content active">
                <div id="resultContent"></div>
            </div>

            <div id="watchlistTab" class="tab-content">
                <div class="add-form">
                    <h3 style="margin-bottom: 15px;">â• æ·»åŠ è‚¡ç¥¨åˆ°é—œæ³¨æ¸…å–®</h3>
                    <div class="form-group">
                        <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" class="form-input" id="addStockCode" placeholder="ä¾‹å¦‚ï¼š2330">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”¢æ¥­åˆ†é¡</label>
                        <select class="form-select" id="addCategory">
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ åˆ°é—œæ³¨æ¸…å–®</button>
                </div>

                <div class="category-filter" id="categoryFilter">
                    <button class="category-btn active" onclick="filterWatchlist('')">å…¨éƒ¨</button>
                </div>

                <div class="watchlist-grid" id="watchlistGrid"></div>
            </div>

            <div id="historyTab" class="tab-content">
                <h3 style="margin-bottom: 15px;">æœ€è¿‘æŸ¥è©¢è¨˜éŒ„</h3>
                <div class="history-list" id="historyList"></div>
            
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .watchlist-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .watchlist-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .watchlist-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .watchlist-name {
            color: #666;
            font-size: 0.9em;
        }

        .watchlist-category {
            display: inline-block;
            padding: 3px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .history-info {
            flex: 1;
        }

        .history-time {
            color: #999;
            font-size: 0.85em;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background: #e0e0e0;
        }

        let currentCategory = '';

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadWatchlist();
            loadHistory();
        });

        function switchTab(tab) {
            // æ›´æ–° tab æ¨£å¼
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tab === 'watchlist') {
                loadWatchlist();
            } else if (tab === 'history') {
                loadHistory();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('addCategory');
                    const filter = document.getElementById('categoryFilter');
                    
                    data.data.forEach(cat => {
                        // æ·»åŠ åˆ°é¸æ“‡æ¡†
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        select.appendChild(option);
                        
                        // æ·»åŠ åˆ°éæ¿¾æŒ‰éˆ•
                        const btn = document.createElement('button');
                        btn.className = 'category-btn';
                        btn.textContent = cat;
                        btn.onclick = () => filterWatchlist(cat);
                        filter.appendChild(btn);
                    });
            // åˆ‡æ›åˆ°æŸ¥è©¢é ç±¤
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('searchTab').classList.add('active');

            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    return;
                }

                // å„²å­˜æŸ¥è©¢æ­·å²
                saveSearchHistory(stockCode, infoData.stock_name);f (data.success && data.data.length > 0) {
                    grid.innerHTML = data.data.map(item => `
                        <div class="watchlist-card" onclick="searchStockById('${item.stock_code}')">
                            <div class="watchlist-header">
                                <div>
                                    <div class="watchlist-code">${item.stock_code}</div>
                                    <div class="watchlist-name">${item.stock_name || 'è¼‰å…¥ä¸­...'}</div>
                                    <span class="watchlist-category">${item.category}</span>
                                </div>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteFromWatchlist(${item.id})">åˆªé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡é—œæ³¨è‚¡ç¥¨</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥é—œæ³¨æ¸…å–®å¤±æ•—:', error);
            }
        }

        function filterWatchlist(category) {
            currentCategory = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((category === '' && btn.textContent === 'å…¨éƒ¨') || btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            loadWatchlist(category);
        }

        async function addToWatchlist() {
            const stockCode = document.getElementById('addStockCode').value.trim();
            const category = document.getElementById('addCategory').value;
            
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            if (!category) {
                alert('è«‹é¸æ“‡ç”¢æ¥­åˆ†é¡');
                return;
            }
            
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, category: category })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('addStockCode').value = '';
                    document.getElementById('addCategory').value = '';
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'æ·»åŠ å¤±æ•—');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±æ•—: ' + error.message);
            }
        }

        async function deleteFromWatchlist(id) {
            if (!confirm('ç¢ºå®šè¦å¾é—œæ³¨æ¸…å–®ä¸­ç§»é™¤æ­¤è‚¡ç¥¨å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/watchlist/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                const list = document.getElementById('historyList');
                
                if (data.success && data.data.length > 0) {
                    list.innerHTML = data.data.map(item => `
                        <div class="history-item" onclick="searchStockById('${item.stock_code}')">
                            <div class="history-info">
                                <div><strong>${item.stock_code}</strong> ${item.stock_name || ''}</div>
                                <div class="history-time">${new Date(item.search_time).toLocaleString('zh-TW')}</div>
                            </div>
                            <span>â†’</span>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡æŸ¥è©¢è¨˜éŒ„</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        async function saveSearchHistory(stockCode, stockName) {
            try {
                await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, stock_name: stockName })
                });
            } catch (error) {
                console.error('å„²å­˜æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        function searchStockById(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            switchTab('search');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            searchStock();
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .kline {
            width: 100%;
            height: 500px;
            margin-top: 20px;
            background: #1a1a2e;
            border-radius: 10px;
            border: 1px solid #2d2d44;
        }

        @media (max-width: 768px) {
            .kline {
                height: 350px;
            }
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        #chartAndNewsContainer {
            width: 100%;
        }

        .chart-btn {
            padding: 10px 20px;
            background: #2a2a3e;
            border: 2px solid #5a7fc7;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #5a7fc7;
            font-weight: 600;
        }

        .chart-btn.active {
            background: #5a7fc7;
            color: white;
            border-color: #5a7fc7;
        }

        .chart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 199, 0.5);
        }

        .auto-refresh-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 12px 20px;
            background: #2a2a3e;
            border-radius: 10px;
            border: 1px solid #3a3a52;
        }

        .refresh-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .refresh-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .refresh-toggle input:checked + .toggle-slider {
            background-color: #5a7fc7;
        }

        .refresh-toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .refresh-status {
            color: #c0c0c0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .refresh-indicator.active {
            background: #4ecdc4;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .price-info {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .lang-switcher {
                top: 10px;
                right: 10px;
            }
            
            .price-info {
                grid-template-columns: 1fr;
            }
        }

        .news-panel {
            background: #2a2a3e;
            padding: 20px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #3a3a52;
        }

        @media (max-width: 768px) {
            .news-panel {
                max-height: 400px;
            }
        }

        .news-panel h3 {
            margin-bottom: 15px;
            color: #c0c0c0;
            font-size: 1.2em;
        }

        .news-item {
            padding: 12px;
            background: #1e1e2e;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #5a7fc7;
            transition: all 0.3s;
        }

        .news-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(90, 127, 199, 0.3);
            background: #252538;
        }

        .news-item a {
            color: #7a9fd7;
            text-decoration: none;
            font-weight: 600;
        }

        .news-item a:hover {
            text-decoration: underline;
            color: #9ab5e7;
        }

        .news-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .news-item a {
            text-decoration: none;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .news-item a:hover {
            color: #667eea;
        }

        .news-date {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .news-source {
            display: inline-block;
            font-size: 11px;
            color: #667eea;
            background: #e8ecff;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" id="langZh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLanguage('en')" id="langEn">English</button>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å°è‚¡å³æ™‚æŸ¥è©¢ç³»çµ±</h1>
            <div class="app-version">ğŸ“… æœ€å¾Œæ›´æ–°: 2026-01-16 | AI æ™ºæ…§é¸è‚¡é«˜æ‰‹</div>
            <p>è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢å³æ™‚è³‡è¨Šèˆ‡æ­·å²è³‡æ–™</p>
        </div>

        <div id="authPanel" class="auth-panel">
            <h3>ğŸ” ç™»å…¥ / è¨»å†Š</h3>
            <input type="text" class="auth-input" id="authUserId" placeholder="ä½¿ç”¨è€… ID">
            <input type="password" class="auth-input" id="authPassword" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰">
            <button class="auth-btn" id="loginBtn">ğŸ”‘ ç™»å…¥</button>
            <button class="auth-btn" id="registerBtn">âœ¨ è¨»å†Š</button>
        </div>

        <div class="search-box hidden" id="mainPanel">
            <div class="user-form">
                <div style="flex:1; display:flex; align-items:center;">
                    <span style="font-weight:bold; color:#333;">æ­¡è¿ï¼Œ<span id="currentUser"></span></span>
                    <span id="adminBadge" class="admin-badge hidden">ç®¡ç†å“¡</span>
                </div>
                <button class="search-btn" onclick="loadMyFavorites()">ğŸ’– è¼‰å…¥æˆ‘çš„æœ€æ„›</button>
                <button class="search-btn" onclick="handleLogout()">ğŸšª ç™»å‡º</button>
            </div>
            <div class="search-form">
                <input type="text" class="search-input" id="stockInput" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰">
                <button class="search-btn" onclick="searchStock()">æŸ¥è©¢</button>
            </div>
            <div class="popular-stocks">
                <span style="color: #666; margin-right: 10px;">ç†±é–€è‚¡ç¥¨ï¼š</span>
                <div class="stock-tag" onclick="quickSearch('2330')">2330 å°ç©é›»</div>
                <div class="stock-tag" onclick="quickSearch('2317')">2317 é´»æµ·</div>
                <div class="stock-tag" onclick="quickSearch('2454')">2454 è¯ç™¼ç§‘</div>
                <div class="stock-tag" onclick="quickSearch('2412')">2412 ä¸­è¯é›»</div>
                <div class="stock-tag" onclick="quickSearch('2882')">2882 åœ‹æ³°é‡‘</div>
                <div class="stock-tag" onclick="quickSearch('2303')">2303 è¯é›»</div>
            </div>
        </div>

        <!-- æˆ‘çš„æœ€æ„›å€åŸŸ -->
        <div id="favoritesBox" class="search-box" style="display:none; margin-top: 20px;">
            <h3 style="color: #e0e0e0; margin-bottom: 15px;">ğŸ’– æˆ‘çš„æœ€æ„›è‚¡ç¥¨</h3>
            <div id="favoritesList"></div>
        </div>

        <div class="result-box" id="resultBox">
            <div class="auto-refresh-control" id="autoRefreshControl" style="display:none;">
                <label class="refresh-toggle">
                    <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                    <span class="toggle-slider"></span>
                </label>
                <div class="refresh-status">
                    <span class="refresh-indicator" id="refreshIndicator"></span>
                    <span id="refreshStatusText">è‡ªå‹•æ›´æ–°ï¼šé—œé–‰</span>
                    <span id="refreshCountdown" style="color:#999; font-size:12px;"></span>
                </div>
            </div>
            <div id="resultContent"></div>
            <div id="chartAndNewsContainer" style="display:none;">
                <div class="chart-controls" id="chartControls">
                    <button class="chart-btn active" onclick="switchChart('kline')">ğŸ“Š Kç·š+MA</button>
                    <button class="chart-btn" onclick="switchChart('line')">ğŸ“ˆ å¸ƒæ—é€šé“</button>
                    <button class="chart-btn" onclick="switchChart('volume')">ğŸ“¦ æˆäº¤é‡</button>
                    <button class="chart-btn" onclick="switchChart('ma')">ğŸ“‰ RSI+MACD</button>
                </div>
                <div class="content-grid" id="contentGrid">
                    <div>
                        <div id="kline" class="kline"></div>
                    </div>
                    <div class="news-panel" id="newsPanel">
                        <h3>ğŸ“° ç›¸é—œæ–°è</h3>
                        <div id="newsList">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        let klineChart = null;
        let currentSession = { userId: null, isAdmin: false };
        let currentLang = 'zh';
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let currentStockCode = null;
        let refreshCountdown = 5;
        let countdownInterval = null;

        const i18n = {
            zh: {
                // Header
                systemTitle: 'ğŸ¤– AI æ™ºæ…§é¸è‚¡é«˜æ‰‹',
                systemDesc: 'é‹ç”¨ AI æŠ€è¡“è¼”åŠ©æ‚¨çš„æŠ•è³‡æ±ºç­–ï¼Œè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢å³æ™‚è³‡è¨Šèˆ‡æ­·å²è³‡æ–™',
                // Auth
                loginRegister: 'ğŸ” ç™»å…¥ / è¨»å†Š',
                userId: 'ä½¿ç”¨è€… ID',
                password: 'å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰',
                login: 'ğŸ”‘ ç™»å…¥',
                register: 'âœ¨ è¨»å†Š',
                logout: 'ğŸšª ç™»å‡º',
                welcome: 'æ­¡è¿ï¼Œ',
                admin: 'ç®¡ç†å“¡',
                // Search
                stockCodePlaceholder: 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰',
                search: 'æŸ¥è©¢',
                popularStocks: 'ç†±é–€è‚¡ç¥¨ï¼š',
                loadFavorites: 'ğŸ’– è¼‰å…¥æˆ‘çš„æœ€æ„›',
                // Stock info
                currentPrice: 'ç›®å‰åƒ¹æ ¼',
                openPrice: 'é–‹ç›¤åƒ¹',
                highPrice: 'æœ€é«˜åƒ¹',
                lowPrice: 'æœ€ä½åƒ¹',
                volume: 'æˆäº¤é‡',
                addFavorite: 'åŠ å…¥æœ€æ„›',
                monthlyHistory: 'æœ¬æœˆæ­·å²è³‡æ–™',
                updateTime: 'æ›´æ–°æ™‚é–“',
                // Charts
                klineChart: 'ğŸ“Š Kç·šåœ–',
                lineChart: 'ğŸ“ˆ é«˜ä½æ›²ç·š',
                volumeChart: 'ğŸ“¦ æˆäº¤é‡',
                maChart: 'ğŸ“‰ ç§»å‹•å¹³å‡',
                highLowLine: 'æ­·å²é«˜ä½æ›²ç·š',
                highLabel: 'æœ€é«˜åƒ¹',
                lowLabel: 'æœ€ä½åƒ¹',
                closeLabel: 'æ”¶ç›¤åƒ¹',
                // News
                relatedNews: 'ğŸ“° ç›¸é—œæ–°è',
                loading: 'è¼‰å…¥ä¸­...',
                noNews: 'æš«ç„¡ç›¸é—œæ–°è',
                loadNewsFailed: 'è¼‰å…¥æ–°èå¤±æ•—',
                // Auto-refresh
                autoRefreshOn: 'è‡ªå‹•æ›´æ–°ï¼šé–‹å•Ÿ',
                autoRefreshOff: 'è‡ªå‹•æ›´æ–°ï¼šé—œé–‰',
                nextUpdate: 'ä¸‹æ¬¡æ›´æ–°',
                seconds: 'ç§’',
                // Favorites
                myFavorites: 'æˆ‘çš„æœ€æ„›ï¼š',
                noFavorites: 'å°šç„¡æœ€æ„›',
                adminMode: 'ğŸ‘‘ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‰€æœ‰ä½¿ç”¨è€…çš„æœ€æ„›',
                // Messages
                pleaseLogin: 'è«‹å…ˆç™»å…¥',
                pleaseEnterUserId: 'è«‹è¼¸å…¥ä½¿ç”¨è€… ID èˆ‡å¯†ç¢¼',
                passwordMinLength: 'å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ',
                pleaseEnterStockCode: 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼',
                addFavSuccess: 'å·²æˆåŠŸæ·»åŠ åˆ°æœ€æ„›',
                addFavFailed: 'åŠ å…¥æœ€æ„›å¤±æ•—',
                loadFavFailed: 'è®€å–æœ€æ„›å¤±æ•—',
                registerSuccess: 'è¨»å†ŠæˆåŠŸ',
                registerFailed: 'è¨»å†Šå¤±æ•—',
                loginSuccess: 'ç™»å…¥æˆåŠŸ',
                loginFailed: 'ç™»å…¥å¤±æ•—'
            },
            en: {
                // Header
                systemTitle: 'ğŸ¤– AI Smart Stock Picker',
                systemDesc: 'AI-powered investment decision assistant. Enter stock code to query real-time information and historical data',
                // Auth
                loginRegister: 'ğŸ” Login / Register',
                userId: 'User ID',
                password: 'Password (min 6 chars)',
                login: 'ğŸ”‘ Login',
                register: 'âœ¨ Register',
                logout: 'ğŸšª Logout',
                welcome: 'Welcome, ',
                admin: 'Admin',
                // Search
                stockCodePlaceholder: 'Enter stock code (e.g., 2330)',
                search: 'Search',
                popularStocks: 'Popular Stocks:',
                loadFavorites: 'ğŸ’– Load My Favorites',
                // Stock info
                currentPrice: 'Current Price',
                openPrice: 'Open',
                highPrice: 'High',
                lowPrice: 'Low',
                volume: 'Volume',
                addFavorite: 'Add to Favorites',
                monthlyHistory: 'Monthly Historical Data',
                updateTime: 'Updated',
                // Charts
                klineChart: 'ğŸ“Š K-Line',
                lineChart: 'ğŸ“ˆ High-Low Line',
                volumeChart: 'ğŸ“¦ Volume',
                maChart: 'ğŸ“‰ Moving Avg',
                highLowLine: 'Historical High-Low Line',
                highLabel: 'High',
                lowLabel: 'Low',
                closeLabel: 'Close',
                // News
                relatedNews: 'ğŸ“° Related News',
                loading: 'Loading...',
                noNews: 'No related news',
                loadNewsFailed: 'Failed to load news',
                // Auto-refresh
                autoRefreshOn: 'Auto-refresh: ON',
                autoRefreshOff: 'Auto-refresh: OFF',
                nextUpdate: 'Next update in',
                seconds: 's',
                // Favorites
                myFavorites: 'My Favorites:',
                noFavorites: 'No favorites yet',
                adminMode: 'ğŸ‘‘ Admin Mode: All Users\' Favorites',
                // Messages
                pleaseLogin: 'Please login first',
                pleaseEnterUserId: 'Please enter user ID and password',
                passwordMinLength: 'Password must be at least 6 characters',
                pleaseEnterStockCode: 'Please enter stock code',
                addFavSuccess: 'Successfully added to favorites',
                addFavFailed: 'Failed to add to favorites',
                loadFavFailed: 'Failed to load favorites',
                registerSuccess: 'Registration successful',
                registerFailed: 'Registration failed',
                loginSuccess: 'Login successful',
                loginFailed: 'Login failed'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.getElementById('langZh').classList.toggle('active', lang === 'zh');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            updateUILanguage();
        }

        function updateUILanguage() {
            // Header
            document.querySelector('.header h1').textContent = t('systemTitle');
            document.querySelector('.header p').textContent = t('systemDesc');
            
            // Auth panel
            const authTitle = document.querySelector('#authPanel h3');
            if (authTitle) authTitle.textContent = t('loginRegister');
            document.getElementById('authUserId').placeholder = t('userId');
            document.getElementById('authPassword').placeholder = t('password');
            document.querySelectorAll('#authPanel .auth-btn')[0].textContent = t('login');
            document.querySelectorAll('#authPanel .auth-btn')[1].textContent = t('register');
            
            // Main panel
            const adminBadge = document.getElementById('adminBadge');
            if (adminBadge && !adminBadge.classList.contains('hidden')) {
                adminBadge.textContent = t('admin');
            }
            const loadFavBtn = document.querySelector('#mainPanel .search-btn');
            if (loadFavBtn) loadFavBtn.textContent = t('loadFavorites');
            const logoutBtn = document.querySelectorAll('#mainPanel .search-btn')[1];
            if (logoutBtn) logoutBtn.textContent = t('logout');
            
            // Search
            document.getElementById('stockInput').placeholder = t('stockCodePlaceholder');
            document.querySelector('.search-form .search-btn').textContent = t('search');
            document.querySelector('.popular-stocks span').textContent = t('popularStocks');
            
            // Chart buttons
            const chartBtns = document.querySelectorAll('.chart-btn');
            if (chartBtns[0]) chartBtns[0].textContent = t('klineChart');
            if (chartBtns[1]) chartBtns[1].textContent = t('lineChart');
            if (chartBtns[2]) chartBtns[2].textContent = t('volumeChart');
            if (chartBtns[3]) chartBtns[3].textContent = t('maChart');
            
            // News panel
            const newsTitle = document.querySelector('#newsPanel h3');
            if (newsTitle) newsTitle.textContent = t('relatedNews');
        }

        async function handleRegister() {
            console.log('[DEBUG] handleRegister called');
            const userId = document.getElementById('authUserId').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            console.log('[DEBUG] userId:', userId, 'password length:', password.length);
            
            if (!userId || !password) {
                alert(t('pleaseEnterUserId'));
                return;
            }
            if (password.length < 6) {
                alert(t('passwordMinLength'));
                return;
            }
            try {
                console.log('[DEBUG] Sending register request...');
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });
                const data = await res.json();
                console.log('[DEBUG] Register response:', data);
                if (!data.success) throw new Error(data.message);
                alert(t('registerSuccess') + (data.is_admin ? ' (Admin)' : ''));
                // è¨»å†Šå¾Œè‡ªå‹•ç™»å…¥
                currentSession = { userId: userId, isAdmin: data.is_admin };
                updateUIAfterLogin();
            } catch (e) {
                console.error('[ERROR] Register failed:', e);
                alert(t('registerFailed') + ': ' + e.message);
            }
        }

        async function handleLogin() {
            console.log('[DEBUG] handleLogin called');
            const userId = document.getElementById('authUserId').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            console.log('[DEBUG] userId:', userId, 'password length:', password.length);
            
            if (!userId || !password) {
                alert(t('pleaseEnterUserId'));
                return;
            }
            try {
                console.log('[DEBUG] Sending login request...');
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });
                const data = await res.json();
                console.log('[DEBUG] Login response:', data);
                if (!data.success) throw new Error(data.message);
                currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                updateUIAfterLogin();
                alert(t('loginSuccess'));
            } catch (e) {
                console.error('[ERROR] Login failed:', e);
                alert(t('loginFailed') + ': ' + e.message);
            }
        }

        function handleLogout() {
            currentSession = { userId: null, isAdmin: false };
            document.getElementById('authPanel').classList.remove('hidden');
            document.getElementById('mainPanel').classList.add('hidden');
            document.getElementById('favoritesBox').style.display = 'none';
            document.getElementById('resultBox').classList.remove('show');
            document.getElementById('authUserId').value = '';
            document.getElementById('authPassword').value = '';
            
            // é—œé–‰è‡ªå‹•æ›´æ–°
            if (autoRefreshEnabled) {
                document.getElementById('autoRefreshToggle').checked = false;
                toggleAutoRefresh();
            }
            currentStockCode = null;
        }

        function updateUIAfterLogin() {
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('favoritesBox').style.display = 'block';
            document.getElementById('currentUser').textContent = currentSession.userId;
            if (currentSession.isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
            } else {
                document.getElementById('adminBadge').classList.add('hidden');
            }
            // è‡ªå‹•è¼‰å…¥æœ€æ„›
            loadMyFavorites();
        }

        function quickSearch(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            searchStock();
        }

        async function searchStock() {
            const stockCode = document.getElementById('stockInput').value.trim();
            if (!stockCode) {
                alert(t('pleaseEnterStockCode'));
                return;
            }

            currentStockCode = stockCode;
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultBox.classList.add('show');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    document.getElementById('autoRefreshControl').style.display = 'none';
                    return;
                }

                // ä½¿ç”¨ TA-Lib è¨ˆç®—çš„æŠ€è¡“æŒ‡æ¨™æ•¸æ“š
                const indicatorsResponse = await fetch(`/api/stock/indicators/${stockCode}`);
                const indicatorsData = await indicatorsResponse.json();

                displayResult(infoData, indicatorsData);
                
                // é¡¯ç¤ºè‡ªå‹•æ›´æ–°æ§åˆ¶
                document.getElementById('autoRefreshControl').style.display = 'flex';
                
                // å¦‚æœè‡ªå‹•æ›´æ–°å·²å•Ÿç”¨ï¼Œé‡ç½®è¨ˆæ™‚å™¨
                if (autoRefreshEnabled) {
                    resetRefreshTimer();
                }
            } catch (error) {
                resultContent.innerHTML = `<div class="error">ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
                document.getElementById('autoRefreshControl').style.display = 'none';
            }
        }

        function displayResult(infoData, historyData) {
            let html = '<div class="stock-info">';
            
            // è‚¡ç¥¨æ¨™é¡Œ
            html += `
                <div class="stock-header">
                    <div>
                        <div class="stock-title">${infoData.stock_name}</div>
                        <div class="stock-code">è‚¡ç¥¨ä»£ç¢¼: ${infoData.stock_code}</div>
                    </div>
                    <div>
                        <button class="search-btn" style="padding:10px 16px" onclick="addToFavorites('${infoData.stock_code}', '${infoData.stock_name}')">åŠ å…¥æœ€æ„›</button>
                    </div>
                </div>
            `;

            // å…ˆé¡¯ç¤ºåœ–è¡¨å€åŸŸï¼ˆèˆ‡è¡¨æ ¼äº¤æ›ä½ç½®ï¼‰
            html += '</div>'; // çµæŸ stock-info

            document.getElementById('resultContent').innerHTML = html;

            // ç«‹å³é¡¯ç¤ºåœ–è¡¨å®¹å™¨ä¸¦åˆå§‹åŒ–
            const chartContainer = document.getElementById('chartAndNewsContainer');
            chartContainer.style.display = 'block';
            
            // è¼‰å…¥æ–°è
            loadStockNews(infoData.stock_code);

            // ç¹ªè£½ K ç·šåœ–
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                window.currentHistoryData = historyData;
                // å»¶é²ç¢ºä¿å®¹å™¨å·²ç¶“é¡¯ç¤º
                setTimeout(() => {
                    renderKline(historyData);
                }, 100);
            }

            // åƒ¹æ ¼è³‡è¨Šå’Œè¡¨æ ¼æ·»åŠ åˆ°ä¸‹æ–¹
            html = '<div class="stock-info" style="margin-top: 20px;">';
            const priceChangeClass = parseFloat(infoData.current_price) >= parseFloat(infoData.change) ? 'up' : 'down';
            html += `
                <div class="price-info">
                    <div class="price-card">
                        <div class="price-label">ç›®å‰åƒ¹æ ¼</div>
                        <div class="price-value ${priceChangeClass}">${infoData.current_price}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">é–‹ç›¤åƒ¹</div>
                        <div class="price-value">${infoData.open}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€é«˜åƒ¹</div>
                        <div class="price-value">${infoData.high}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€ä½åƒ¹</div>
                        <div class="price-value">${infoData.low}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æˆäº¤é‡</div>
                        <div class="price-value">${infoData.volume}</div>
                    </div>
                </div>
            `;

            // æ­·å²è³‡æ–™è¡¨æ ¼
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                html += '<h3>æœ¬æœˆæ­·å²è³‡æ–™</h3>';
                html += '<table class="history-table"><thead><tr>';
                html += '<th>æ—¥æœŸ</th><th>é–‹ç›¤</th><th>æœ€é«˜</th><th>æœ€ä½</th><th>æ”¶ç›¤</th><th>æˆäº¤é‡</th>';
                html += '</tr></thead><tbody>';

                // åªé¡¯ç¤ºæœ€è¿‘10ç­†è³‡æ–™
                const recentData = historyData.data.slice(-10).reverse();
                recentData.forEach(row => {
                    html += '<tr>';
                    html += `<td>${row.date}</td>`;
                    html += `<td>${row.open.toFixed(2)}</td>`;
                    html += `<td>${row.high.toFixed(2)}</td>`;
                    html += `<td>${row.low.toFixed(2)}</td>`;
                    html += `<td>${row.close.toFixed(2)}</td>`;
                    html += `<td>${(row.volume / 1000).toFixed(0)}K</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            html += `<div class="update-time">æ›´æ–°æ™‚é–“: ${infoData.time || new Date().toLocaleString('zh-TW')}</div>`;
            html += '</div>';

            document.getElementById('resultContent').innerHTML += html;
        }

        let currentChartType = 'kline';

        function switchChart(chartType) {
            currentChartType = chartType;
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (!window.currentHistoryData) return;
            
            if (chartType === 'kline') {
                renderKline(window.currentHistoryData);
            } else if (chartType === 'line') {
                renderLineChart(window.currentHistoryData);
            } else if (chartType === 'volume') {
                renderVolumeChart(window.currentHistoryData);
            } else if (chartType === 'ma') {
                renderMAChart(window.currentHistoryData);
            }
        }

        async function loadStockNews(stockCode) {
            try {
                document.getElementById('newsList').innerHTML = 'è¼‰å…¥ä¸­...';
                const res = await fetch(`/api/news/${stockCode}`);
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    document.getElementById('newsList').innerHTML = '<p style="color:#999;">æš«ç„¡ç›¸é—œæ–°è</p>';
                    return;
                }
                
                let newsHtml = '';
                data.data.forEach(news => {
                    newsHtml += `
                        <div class="news-item">
                            <a href="${news.link}" target="_blank">${news.title}</a>
                            <div class="news-date">${news.date}</div>
                            <span class="news-source">${news.source}</span>
                        </div>
                    `;
                });
                document.getElementById('newsList').innerHTML = newsHtml;
            } catch (e) {
                document.getElementById('newsList').innerHTML = '<p style="color:#e74c3c;">è¼‰å…¥æ–°èå¤±æ•—</p>';
            }
        }

        async function addToFavorites(stockCode, stockName) {
            if (!currentSession.userId) {
                alert(t('pleaseLogin'));
                return;
            }
            try {
                const res = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentSession.userId, stock_code: stockCode, stock_name: stockName })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'åŠ å…¥æœ€æ„›å¤±æ•—');
                alert(t('addFavSuccess'));
                await loadMyFavorites();
            } catch (e) {
                alert(t('addFavFailed') + 'ï¼š' + e.message);
            }
        }

        async function loadMyFavorites() {
            if (!currentSession.userId) {
                return;
            }
            try {
                const res = await fetch(`/api/favorites?user_id=${encodeURIComponent(currentSession.userId)}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'è®€å–æœ€æ„›å¤±æ•—');
                const listEl = document.getElementById('favoritesList');
                
                if (data.is_admin) {
                    // ç®¡ç†å“¡ï¼šæŒ‰ä½¿ç”¨è€…åˆ†çµ„é¡¯ç¤º
                    const grouped = {};
                    (data.data || []).forEach(it => {
                        const uid = it.user_id || 'unknown';
                        if (!grouped[uid]) grouped[uid] = [];
                        grouped[uid].push(it);
                    });
                    let html = '<div style="margin-top:8px; color:#c0c0c0; font-weight:bold;">ğŸ‘‘ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‰€æœ‰ä½¿ç”¨è€…çš„æœ€æ„›</div>';
                    for (const uid in grouped) {
                        html += `<div style="margin-top:12px; color:#9ab5e7; font-weight:bold;">ğŸ‘¤ ${uid}</div>`;
                        html += '<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">';
                        grouped[uid].forEach(it => {
                            const code = it.stock_code || '';
                            const name = it.stock_name || '';
                            html += `<span class="stock-tag" onclick="quickSearch('${code}')">${code} ${name}</span>`;
                        });
                        html += '</div>';
                    }
                    listEl.innerHTML = html;
                } else {
                    // ä¸€èˆ¬ä½¿ç”¨è€…
                    const items = (data.data || []).map(it => {
                        const code = it.stock_code || '';
                        const name = it.stock_name || '';
                        return `<span class="stock-tag" onclick="quickSearch('${code}')">${code} ${name}</span>`;
                    }).join(' ');
                    if (items) {
                        listEl.innerHTML = '<div style="display:flex; flex-wrap:wrap; gap:8px;">' + items + '</div>';
                    } else {
                        listEl.innerHTML = '<div style="margin-top:8px; color:#999; text-align:center; padding:20px;">å°šç„¡æœ€æ„›è‚¡ç¥¨ï¼Œè«‹å…ˆæŸ¥è©¢è‚¡ç¥¨å¾Œé»æ“Šã€ŒåŠ å…¥æœ€æ„›ã€æŒ‰éˆ•</div>';
                    }
                }
            } catch (e) {
                console.error('è®€å–æœ€æ„›å¤±æ•—ï¼š', e);
            }
        }

        function parseNumber(value) {
            if (value === null || value === undefined) return null;
            const v = String(value).replace(/,/g, '').trim();
            if (v === '-' || v === '' || v.toLowerCase() === 'nan') return null;
            const n = Number(v);
            return isNaN(n) ? null : n;
        }

        function normalizeDate(d) {
            // å°‡ 2025/01/02 æˆ– 114/01/02 æ ¼å¼è½‰ç‚º Date ç‰©ä»¶æˆ–å­—ä¸²
            // ç›´æ¥å›å‚³åŸå­—ä¸²ä»¥ä¾› X è»¸é¡ç›®é¡¯ç¤º
            return String(d).replace(/\./g, '/');
        }

        function renderKline(historyData) {
            try {
                if (!historyData.success || !historyData.data) {
                    console.error('Invalid history data');
                    return;
                }
                
                const data = historyData.data;
                // TA-Lib æ ¼å¼ï¼šæ¯ç­†åŒ…å« date, open, high, low, close, volume, ma5, ma10, ma20, ma60 ç­‰
                const rows = data.slice(-60);  // å–æœ€è¿‘ 60 ç­†
                const dates = rows.map(r => normalizeDate(r.date));
                const ohlc = rows.map(r => [
                    parseNumber(r.open),  // é–‹
                    parseNumber(r.close), // æ”¶
                    parseNumber(r.high),  // é«˜
                    parseNumber(r.low)    // ä½
                ]);
                
                // æå– MA æ•¸æ“š
                const ma5Data = rows.map(r => r.ma5);
                const ma10Data = rows.map(r => r.ma10);
                const ma20Data = rows.map(r => r.ma20);
                const ma60Data = rows.map(r => r.ma60);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#1a1a2e',
                    title: { 
                        text: 'Kç·šåœ– + ç§»å‹•å¹³å‡ç·š (TA-Lib)', 
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 16, color: '#e0e0e0', fontWeight: 'bold' } 
                    },
                    legend: {
                        data: ['Kç·š', 'MA5', 'MA10', 'MA20', 'MA60'],
                        top: 40,
                        textStyle: { color: '#c0c0c0' }
                    },
                    grid: { left: 50, right: 20, top: 90, bottom: 70 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        backgroundColor: 'rgba(50, 50, 70, 0.95)',
                        borderColor: '#5a7fc7',
                        borderWidth: 1,
                        textStyle: { color: '#e0e0e0' },
                        valueFormatter: (v) => (v == null ? '-' : Number(v).toFixed(2))
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        boundaryGap: true,
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        scale: true,
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            formatter: (v) => Number(v).toFixed(1)
                        },
                        splitLine: { lineStyle: { color: 'rgba(90, 127, 199, 0.15)' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: 'Kç·š',
                            type: 'candlestick',
                            data: ohlc,
                            itemStyle: {
                                color: '#e74c3c',      // æ¼²ï¼ˆæ”¶>=é–‹ï¼‰ç”¨ç´…
                                color0: '#27ae60',     // è·Œï¼ˆæ”¶<é–‹ï¼‰ç”¨ç¶ 
                                borderColor: '#e74c3c',
                                borderColor0: '#27ae60'
                            }
                        },
                        {
                            name: 'MA5',
                            type: 'line',
                            data: ma5Data,
                            smooth: true,
                            lineStyle: { color: '#FF6B6B', width: 1.5 },
                            showSymbol: false
                        },
                        {
                            name: 'MA10',
                            type: 'line',
                            data: ma10Data,
                            smooth: true,
                            lineStyle: { color: '#4ECDC4', width: 1.5 },
                            showSymbol: false
                        },
                        {
                            name: 'MA20',
                            type: 'line',
                            data: ma20Data,
                            smooth: true,
                            lineStyle: { color: '#FFD93D', width: 1.5 },
                            showSymbol: false
                        },
                        {
                            name: 'MA60',
                            type: 'line',
                            data: ma60Data,
                            smooth: true,
                            lineStyle: { color: '#95E1D3', width: 1.5 },
                            showSymbol: false
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render K-line error:', e);
            }
        }

        function renderLineChart(historyData) {
            try {
                if (!historyData.success || !historyData.data) return;
                
                const data = historyData.data;
                const rows = data.slice(-60);
                const dates = rows.map(r => normalizeDate(r.date));
                const highs = rows.map(r => parseNumber(r.high));
                const lows = rows.map(r => parseNumber(r.low));
                const closes = rows.map(r => parseNumber(r.close));
                const bollUpper = rows.map(r => r.boll_upper);
                const bollMiddle = rows.map(r => r.boll_middle);
                const bollLower = rows.map(r => r.boll_lower);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#1a1a2e',
                    title: { 
                        text: 'åƒ¹æ ¼æ›²ç·š + å¸ƒæ—é€šé“ (TA-Lib)', 
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 16, color: '#e0e0e0', fontWeight: 'bold' } 
                    },
                    grid: { left: 50, right: 30, top: 90, bottom: 70 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { 
                            type: 'cross',
                            crossStyle: { color: '#5a7fc7' }
                        },
                        backgroundColor: 'rgba(50, 50, 70, 0.95)',
                        borderColor: '#5a7fc7',
                        borderWidth: 1,
                        textStyle: { color: '#e0e0e0' },
                        valueFormatter: (v) => (v == null ? '-' : Number(v).toFixed(2))
                    },
                    legend: {
                        data: ['æœ€é«˜åƒ¹', 'æœ€ä½åƒ¹', 'æ”¶ç›¤åƒ¹', 'BOLLä¸Šè»Œ', 'BOLLä¸­è»Œ', 'BOLLä¸‹è»Œ'],
                        top: 45,
                        textStyle: { color: '#c0c0c0', fontSize: 11 },
                        itemWidth: 25,
                        itemHeight: 12
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true,
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            formatter: (v) => Number(v).toFixed(1)
                        },
                        splitLine: { lineStyle: { color: 'rgba(90, 127, 199, 0.15)' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: currentLang === 'zh' ? 'æœ€é«˜åƒ¹' : 'High',
                            type: 'line',
                            data: highs,
                            smooth: true,
                            lineStyle: { color: '#ff6b9d', width: 3 },
                            itemStyle: { color: '#ff6b9d' },
                            showSymbol: false,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: [
                                        { offset: 0, color: 'rgba(255, 107, 157, 0.3)' },
                                        { offset: 1, color: 'rgba(255, 107, 157, 0.05)' }
                                    ]
                                }
                            }
                        },
                        {
                            name: 'æœ€ä½åƒ¹',
                            type: 'line',
                            data: lows,
                            smooth: true,
                            lineStyle: { color: '#4ecdc4', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'æ”¶ç›¤åƒ¹',
                            type: 'line',
                            data: closes,
                            smooth: true,
                            lineStyle: { color: '#ffe66d', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'BOLLä¸Šè»Œ',
                            type: 'line',
                            data: bollUpper,
                            smooth: true,
                            lineStyle: { color: '#ff6b9d', width: 1, type: 'dashed' },
                            showSymbol: false
                        },
                        {
                            name: 'BOLLä¸­è»Œ',
                            type: 'line',
                            data: bollMiddle,
                            smooth: true,
                            lineStyle: { color: '#a8dadc', width: 1.5 },
                            showSymbol: false
                        },
                        {
                            name: 'BOLLä¸‹è»Œ',
                            type: 'line',
                            data: bollLower,
                            smooth: true,
                            lineStyle: { color: '#ff6b9d', width: 1, type: 'dashed' },
                            showSymbol: false
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render line chart error:', e);
            }
        }

        function renderVolumeChart(historyData) {
            try {
                if (!historyData.success || !historyData.data) return;
                
                const data = historyData.data;
                const rows = data.slice(-60);
                const dates = rows.map(r => normalizeDate(r.date));
                const volumes = rows.map(r => parseNumber(r.volume));
                const volumeMa5 = rows.map(r => r.volume_ma5);
                const volumeMa10 = rows.map(r => r.volume_ma10);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#1a1a2e',
                    title: { 
                        text: 'æˆäº¤é‡åˆ†æ (TA-Lib)', 
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 16, color: '#e0e0e0', fontWeight: 'bold' } 
                    },
                    grid: { left: 60, right: 30, top: 90, bottom: 70 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'shadow' },
                        backgroundColor: 'rgba(50, 50, 70, 0.95)',
                        borderColor: '#5a7fc7',
                        borderWidth: 1,
                        textStyle: { color: '#e0e0e0' },
                        formatter: (params) => {
                            let result = params[0].name + '<br/>';
                            params.forEach(p => {
                                const val = p.value ? Number(p.value).toLocaleString() : '-';
                                result += p.marker + p.seriesName + ': ' + val + '<br/>';
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: ['æˆäº¤é‡', 'VOL MA5', 'VOL MA10'],
                        top: 45,
                        textStyle: { color: '#c0c0c0', fontSize: 13 }
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            rotate: 45,
                            fontSize: 10
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æˆäº¤é‡',
                        axisLine: { lineStyle: { color: '#5a7fc7' } },
                        axisLabel: { 
                            color: '#c0c0c0',
                            formatter: (v) => (v / 1000).toFixed(0) + 'K'
                        },
                        splitLine: { lineStyle: { color: 'rgba(90, 127, 199, 0.15)' } },
                        nameTextStyle: { color: '#c0c0c0' }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: currentLang === 'zh' ? 'æˆäº¤è‚¡æ•¸' : 'Volume',
                            type: 'bar',
                            data: volumes,
                            yAxisIndex: 0,
                            itemStyle: { 
                                color: {
                                    type: 'linear',
                                    x: 0, y: 0, x2: 0, y2: 1,
                                    colorStops: [
                                        { offset: 0, color: '#7aa3ff' },
                                        { offset: 1, color: '#4a6fa5' }
                                    ]
                                }
                            },
                            barMaxWidth: 20
                        }
                    ],
                    series: [
                        {
                            name: 'æˆäº¤é‡',
                            type: 'bar',
                            data: volumes,
                            itemStyle: { 
                                color: '#5a7fc7',
                                borderRadius: [4, 4, 0, 0]
                            },
                            barMaxWidth: 20
                        },
                        {
                            name: 'VOL MA5',
                            type: 'line',
                            data: volumeMa5,
                            smooth: true,
                            lineStyle: { color: '#ff6b9d', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'VOL MA10',
                            type: 'line',
                            data: volumeMa10,
                            smooth: true,
                            lineStyle: { color: '#4ecdc4', width: 2 },
                            showSymbol: false
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render volume chart error:', e);
            }
        }

        function renderMAChart(historyData) {
            try {
                if (!historyData.success || !historyData.data) return;
                
                const data = historyData.data;
                const rows = data.slice(-60);
                const dates = rows.map(r => normalizeDate(r.date));
                const rsi6 = rows.map(r => r.rsi6);
                const rsi12 = rows.map(r => r.rsi12);
                const macd = rows.map(r => r.macd);
                const macdSignal = rows.map(r => r.macd_signal);
                const macdHist = rows.map(r => r.macd_hist);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#1a1a2e',
                    title: { 
                        text: currentLang === 'zh' ? 'ç§»å‹•å¹³å‡ç·š (MA)' : 'Moving Average (MA)', 
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 16, color: '#e0e0e0', fontWeight: 'bold' } 
                    },
                    grid: { left: 50, right: 30, top: 90, bottom: 70 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { 
                            type: 'cross',
                            crossStyle: { color: '#5a7fc7' }
                        },
                        backgroundColor: 'rgba(50, 50, 70, 0.95)',
                        borderColor: '#5a7fc7',
                        borderWidth: 1,
                        textStyle: { color: '#e0e0e0' },
                        valueFormatter: (v) => (v == null ? '-' : Number(v).toFixed(2))
                    },
                    legend: {
                        data: currentLang === 'zh' ? ['æ”¶ç›¤åƒ¹', 'MA5', 'MA10', 'MA20', 'MA60'] : ['Close', 'MA5', 'MA10', 'MA20', 'MA60'],
                        top: 45,
                        textStyle: { color: '#c0c0c0', fontSize: 12 },
                        itemWidth: 25,
                    title: { 
                        text: 'RSI + MACD æŠ€è¡“æŒ‡æ¨™ (TA-Lib)', 
                        left: 'center',
                        top: 10,
                        textStyle: { fontSize: 16, color: '#e0e0e0', fontWeight: 'bold' } 
                    },
                    legend: {
                        data: ['RSI6', 'RSI12', 'MACD', 'Signal', 'Histogram'],
                        top: 45,
                        textStyle: { color: '#c0c0c0', fontSize: 11 },
                        itemWidth: 25,
                        itemHeight: 12
                    },
                    grid: [
                        { left: 50, right: 30, top: 90, height: '35%' },
                        { left: 50, right: 30, top: '55%', height: '35%' }
                    ],
                    xAxis: [
                        {
                            type: 'category',
                            data: dates,
                            gridIndex: 0,
                            axisLine: { lineStyle: { color: '#5a7fc7' } },
                            axisLabel: { show: false }
                        },
                        {
                            type: 'category',
                            data: dates,
                            gridIndex: 1,
                            axisLine: { lineStyle: { color: '#5a7fc7' } },
                            axisLabel: { 
                                color: '#c0c0c0',
                                rotate: 45,
                                fontSize: 10
                            }
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: 'RSI',
                            gridIndex: 0,
                            min: 0,
                            max: 100,
                            axisLine: { lineStyle: { color: '#5a7fc7' } },
                            axisLabel: { color: '#c0c0c0' },
                            splitLine: { lineStyle: { color: 'rgba(90, 127, 199, 0.15)' } }
                        },
                        {
                            type: 'value',
                            name: 'MACD',
                            gridIndex: 1,
                            axisLine: { lineStyle: { color: '#5a7fc7' } },
                            axisLabel: { color: '#c0c0c0' },
                            splitLine: { lineStyle: { color: 'rgba(90, 127, 199, 0.15)' } }
                        }
                    ],
                    dataZoom: [
                        { type: 'inside', xAxisIndex: [0, 1], start: 40, end: 100 },
                        { xAxisIndex: [0, 1], start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: 'RSI6',
                            type: 'line',
                            data: rsi6,
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            smooth: true,
                            lineStyle: { color: '#ff6b9d', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'RSI12',
                            type: 'line',
                            data: rsi12,
                            xAxisIndex: 0,
                            yAxisIndex: 0,
                            smooth: true,
                            lineStyle: { color: '#4ecdc4', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'MACD',
                            type: 'line',
                            data: macd,
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            smooth: true,
                            lineStyle: { color: '#ffe66d', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'Signal',
                            type: 'line',
                            data: macdSignal,
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            smooth: true,
                            lineStyle: { color: '#a29bfe', width: 2 },
                            showSymbol: false
                        },
                        {
                            name: 'Histogram',
                            type: 'bar',
                            data: macdHist,
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            itemStyle: { 
                                color: (params) => params.value >= 0 ? '#e74c3c' : '#27ae60'
                            },
                            barMaxWidth: 10
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render MA chart error:', e);
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = document.getElementById('autoRefreshToggle').checked;
            const indicator = document.getElementById('refreshIndicator');
            const statusText = document.getElementById('refreshStatusText');
            
            if (autoRefreshEnabled) {
                indicator.classList.add('active');
                statusText.textContent = t('autoRefreshOn');
                resetRefreshTimer();
            } else {
                indicator.classList.remove('active');
                statusText.textContent = t('autoRefreshOff');
                clearRefreshTimer();
            }
        }

        function resetRefreshTimer() {
            clearRefreshTimer();
            refreshCountdown = 5;
            updateCountdownDisplay();
            
            // å€æ•¸è¨ˆæ™‚
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                updateCountdownDisplay();
                
                if (refreshCountdown <= 0) {
                    refreshCountdown = 5;
                }
            }, 1000);
            
            // ä¸»æ›´æ–°è¨ˆæ™‚
            autoRefreshInterval = setInterval(() => {
                if (currentStockCode && autoRefreshEnabled) {
                    refreshStockData();
                }
            }, 5000);
        }

        function clearRefreshTimer() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            document.getElementById('refreshCountdown').textContent = '';
        }

        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('refreshCountdown');
            if (autoRefreshEnabled && refreshCountdown > 0) {
                countdownEl.textContent = `(${t('nextUpdate')} ${refreshCountdown}${t('seconds')})`;
            } else {
                countdownEl.textContent = '';
            }
        }

        async function refreshStockData() {
            if (!currentStockCode) return;
            
            try {
                // é™é»˜æ›´æ–°ï¼Œä¸é¡¯ç¤º loading
                const infoResponse = await fetch(`/api/stock/${currentStockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) return;

                const indicatorsResponse = await fetch(`/api/stock/indicators/${currentStockCode}`);
                const indicatorsData = await indicatorsResponse.json();

                displayResult(infoData, indicatorsData);
                
                // é‡ç½®å€æ•¸
                refreshCountdown = 5;
            } catch (error) {
                console.error('è‡ªå‹•æ›´æ–°å¤±æ•—:', error);
            }
        }

        // Enter éµæœå°‹
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æŸ¥è©¢æœ€æ„›ç¬¬ä¸€å€‹
        window.addEventListener('load', function() {
            setTimeout(async () => {
                if (currentSession.userId) {
                    try {
                        const response = await fetch('/api/favorites');
                        const data = await response.json();
                        if (data.success && data.data && data.data.length > 0) {
                            const firstFavorite = data.data[0];
                            document.getElementById('stockInput').value = firstFavorite.stock_code;
                            searchStock();
                        }
                    } catch (error) {
                        console.log('ç„¡æœ€æ„›è‚¡ç¥¨');
                    }
                }
            }, 800);
        });

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æŸ¥è©¢æœ€æ„›åˆ—è¡¨ç¬¬ä¸€å€‹è‚¡ç¥¨
        window.addEventListener('DOMContentLoaded', async function() {
            // æ·»åŠ ç™»å…¥/è¨»å†ŠæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }
            
            // ç­‰å¾…ç™»å…¥ç‹€æ…‹è¼‰å…¥
            setTimeout(async () => {
                if (currentSession.userId) {
                    try {
                        const response = await fetch('/api/favorites');
                        const data = await response.json();
                        if (data.success && data.data && data.data.length > 0) {
                            const firstFavorite = data.data[0];
                            document.getElementById('stockInput').value = firstFavorite.stock_code;
                            searchStock();
                        }
                    } catch (error) {
                        console.error('è‡ªå‹•è¼‰å…¥æœ€æ„›å¤±æ•—:', error);
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
