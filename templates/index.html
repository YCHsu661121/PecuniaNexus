<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡å³æ™‚æŸ¥è©¢ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-input {
            flex: 0 0 220px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .search-btn {
            padding: 15px 30px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stock-tag {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .stock-tag:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .result-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stock-info {
            margin-bottom: 30px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .stock-title {
            font-size: 1.8em;
            color: #333;
        }

        .stock-code {
            color: #666;
            font-size: 0.8em;
        }

        .price-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .price-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .price-value.up {
            color: #e74c3c;
        }

        .price-value.down {
            color: #27ae60;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .history-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            padding: 20px;
            background: #fee;
            border-left: 4px solid #e74c3c;
            border-radius: 5px;
            color: #c33;
        }

        .update-time {
            text-align: right;
            color: #999;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-colo show">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">ğŸ“Š æŸ¥è©¢è‚¡ç¥¨</button>
                <button class="tab" onclick="switchTab('watchlist')">â­ é—œæ³¨æ¸…å–®</button>
                <button class="tab" onclick="switchTab('history')">ğŸ• æŸ¥è©¢æ­·å²</button>
            </div>

            <div id="searchTab" class="tab-content active">
                <div id="resultContent"></div>
            </div>

            <div id="watchlistTab" class="tab-content">
                <div class="add-form">
                    <h3 style="margin-bottom: 15px;">â• æ·»åŠ è‚¡ç¥¨åˆ°é—œæ³¨æ¸…å–®</h3>
                    <div class="form-group">
                        <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" class="form-input" id="addStockCode" placeholder="ä¾‹å¦‚ï¼š2330">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”¢æ¥­åˆ†é¡</label>
                        <select class="form-select" id="addCategory">
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ åˆ°é—œæ³¨æ¸…å–®</button>
                </div>

                <div class="category-filter" id="categoryFilter">
                    <button class="category-btn active" onclick="filterWatchlist('')">å…¨éƒ¨</button>
                </div>

                <div class="watchlist-grid" id="watchlistGrid"></div>
            </div>

            <div id="historyTab" class="tab-content">
                <h3 style="margin-bottom: 15px;">æœ€è¿‘æŸ¥è©¢è¨˜éŒ„</h3>
                <div class="history-list" id="historyList"></div>
            
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .watchlist-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .watchlist-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .watchlist-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .watchlist-name {
            color: #666;
            font-size: 0.9em;
        }

        .watchlist-category {
            display: inline-block;
            padding: 3px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .history-info {
            flex: 1;
        }

        .history-time {
            color: #999;
            font-size: 0.85em;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background: #e0e0e0;
        }

        let currentCategory = '';

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadWatchlist();
            loadHistory();
        });

        function switchTab(tab) {
            // æ›´æ–° tab æ¨£å¼
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tab === 'watchlist') {
                loadWatchlist();
            } else if (tab === 'history') {
                loadHistory();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('addCategory');
                    const filter = document.getElementById('categoryFilter');
                    
                    data.data.forEach(cat => {
                        // æ·»åŠ åˆ°é¸æ“‡æ¡†
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        select.appendChild(option);
                        
                        // æ·»åŠ åˆ°éæ¿¾æŒ‰éˆ•
                        const btn = document.createElement('button');
                        btn.className = 'category-btn';
                        btn.textContent = cat;
                        btn.onclick = () => filterWatchlist(cat);
                        filter.appendChild(btn);
                    });
            // åˆ‡æ›åˆ°æŸ¥è©¢é ç±¤
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('searchTab').classList.add('active');

            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    return;
                }

                // å„²å­˜æŸ¥è©¢æ­·å²
                saveSearchHistory(stockCode, infoData.stock_name);f (data.success && data.data.length > 0) {
                    grid.innerHTML = data.data.map(item => `
                        <div class="watchlist-card" onclick="searchStockById('${item.stock_code}')">
                            <div class="watchlist-header">
                                <div>
                                    <div class="watchlist-code">${item.stock_code}</div>
                                    <div class="watchlist-name">${item.stock_name || 'è¼‰å…¥ä¸­...'}</div>
                                    <span class="watchlist-category">${item.category}</span>
                                </div>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteFromWatchlist(${item.id})">åˆªé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡é—œæ³¨è‚¡ç¥¨</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥é—œæ³¨æ¸…å–®å¤±æ•—:', error);
            }
        }

        function filterWatchlist(category) {
            currentCategory = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((category === '' && btn.textContent === 'å…¨éƒ¨') || btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            loadWatchlist(category);
        }

        async function addToWatchlist() {
            const stockCode = document.getElementById('addStockCode').value.trim();
            const category = document.getElementById('addCategory').value;
            
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            if (!category) {
                alert('è«‹é¸æ“‡ç”¢æ¥­åˆ†é¡');
                return;
            }
            
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, category: category })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('addStockCode').value = '';
                    document.getElementById('addCategory').value = '';
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'æ·»åŠ å¤±æ•—');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±æ•—: ' + error.message);
            }
        }

        async function deleteFromWatchlist(id) {
            if (!confirm('ç¢ºå®šè¦å¾é—œæ³¨æ¸…å–®ä¸­ç§»é™¤æ­¤è‚¡ç¥¨å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/watchlist/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                const list = document.getElementById('historyList');
                
                if (data.success && data.data.length > 0) {
                    list.innerHTML = data.data.map(item => `
                        <div class="history-item" onclick="searchStockById('${item.stock_code}')">
                            <div class="history-info">
                                <div><strong>${item.stock_code}</strong> ${item.stock_name || ''}</div>
                                <div class="history-time">${new Date(item.search_time).toLocaleString('zh-TW')}</div>
                            </div>
                            <span>â†’</span>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡æŸ¥è©¢è¨˜éŒ„</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        async function saveSearchHistory(stockCode, stockName) {
            try {
                await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, stock_name: stockName })
                });
            } catch (error) {
                console.error('å„²å­˜æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        function searchStockById(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            switchTab('search');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            searchStock();
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .kline {
            width: 100%;
            height: 420px;
            margin-top: 20px;
            background: #fff;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å°è‚¡å³æ™‚æŸ¥è©¢ç³»çµ±</h1>
            <p>è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢å³æ™‚è³‡è¨Šèˆ‡æ­·å²è³‡æ–™</p>
        </div>

        <div class="search-box">
            <div class="user-form">
                <input type="text" class="user-input" id="userIdInput" placeholder="è¼¸å…¥ä½¿ç”¨è€… IDï¼ˆä¾‹å¦‚ï¼šdemoï¼‰">
                <button class="search-btn" onclick="loadMyFavorites()">è¼‰å…¥æˆ‘çš„æœ€æ„›</button>
            </div>
            <div class="search-form">
                <input type="text" class="search-input" id="stockInput" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰">
                <button class="search-btn" onclick="searchStock()">æŸ¥è©¢</button>
            </div>
            <div class="popular-stocks">
                <span style="color: #666; margin-right: 10px;">ç†±é–€è‚¡ç¥¨ï¼š</span>
                <div class="stock-tag" onclick="quickSearch('2330')">2330 å°ç©é›»</div>
                <div class="stock-tag" onclick="quickSearch('2317')">2317 é´»æµ·</div>
                <div class="stock-tag" onclick="quickSearch('2454')">2454 è¯ç™¼ç§‘</div>
                <div class="stock-tag" onclick="quickSearch('2412')">2412 ä¸­è¯é›»</div>
                <div class="stock-tag" onclick="quickSearch('2882')">2882 åœ‹æ³°é‡‘</div>
                <div class="stock-tag" onclick="quickSearch('2303')">2303 è¯é›»</div>
            </div>
        </div>

        <div class="result-box" id="resultBox">
            <div id="resultContent"></div>
            <div id="favoritesList" style="margin-top: 16px;"></div>
        </div>
    </div>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        let klineChart = null;

        function quickSearch(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            searchStock();
        }

        async function searchStock() {
            const stockCode = document.getElementById('stockInput').value.trim();
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultBox.classList.add('show');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    return;
                }

                // ç²å–æ­·å²è³‡æ–™
                const historyResponse = await fetch(`/api/stock/history/${stockCode}`);
                const historyData = await historyResponse.json();

                displayResult(infoData, historyData);
            } catch (error) {
                resultContent.innerHTML = `<div class="error">ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }

        function displayResult(infoData, historyData) {
            let html = '<div class="stock-info">';
            
            // è‚¡ç¥¨æ¨™é¡Œ
            html += `
                <div class="stock-header">
                    <div>
                        <div class="stock-title">${infoData.stock_name}</div>
                        <div class="stock-code">è‚¡ç¥¨ä»£ç¢¼: ${infoData.stock_code}</div>
                    </div>
                    <div>
                        <button class="search-btn" style="padding:10px 16px" onclick="addToFavorites('${infoData.stock_code}', '${infoData.stock_name}')">åŠ å…¥æœ€æ„›</button>
                    </div>
                </div>
            `;

            // åƒ¹æ ¼è³‡è¨Š
            const priceChangeClass = parseFloat(infoData.current_price) >= parseFloat(infoData.change) ? 'up' : 'down';
            html += `
                <div class="price-info">
                    <div class="price-card">
                        <div class="price-label">ç›®å‰åƒ¹æ ¼</div>
                        <div class="price-value ${priceChangeClass}">${infoData.current_price}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">é–‹ç›¤åƒ¹</div>
                        <div class="price-value">${infoData.open}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€é«˜åƒ¹</div>
                        <div class="price-value">${infoData.high}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€ä½åƒ¹</div>
                        <div class="price-value">${infoData.low}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æˆäº¤é‡</div>
                        <div class="price-value">${infoData.volume}</div>
                    </div>
                </div>
            `;

            // K ç·šåœ–å®¹å™¨
            html += `<div id="kline" class="kline"></div>`;

            // æ­·å²è³‡æ–™è¡¨æ ¼
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                html += '<h3>æœ¬æœˆæ­·å²è³‡æ–™</h3>';
                html += '<table class="history-table"><thead><tr>';
                
                historyData.fields.forEach(field => {
                    html += `<th>${field}</th>`;
                });
                html += '</tr></thead><tbody>';

                // åªé¡¯ç¤ºæœ€è¿‘10ç­†è³‡æ–™
                const recentData = historyData.data.slice(-10).reverse();
                recentData.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${cell}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            html += `<div class="update-time">æ›´æ–°æ™‚é–“: ${infoData.time || new Date().toLocaleString('zh-TW')}</div>`;
            html += '</div>';

            document.getElementById('resultContent').innerHTML = html;

            // ç¹ªè£½ K ç·šåœ–ï¼ˆè‹¥æœ‰æ­·å²è³‡æ–™ï¼‰
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                renderKline(historyData);
            }
        }

        async function addToFavorites(stockCode, stockName) {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                alert('è«‹å…ˆè¼¸å…¥ä½¿ç”¨è€… ID');
                return;
            }
            try {
                const res = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, stock_code: stockCode, stock_name: stockName })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'åŠ å…¥æœ€æ„›å¤±æ•—');
                await loadMyFavorites();
            } catch (e) {
                alert('åŠ å…¥æœ€æ„›å¤±æ•—ï¼š' + e.message);
            }
        }

        async function loadMyFavorites() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                alert('è«‹å…ˆè¼¸å…¥ä½¿ç”¨è€… ID');
                return;
            }
            try {
                const res = await fetch(`/api/favorites?user_id=${encodeURIComponent(userId)}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'è®€å–æœ€æ„›å¤±æ•—');
                const listEl = document.getElementById('favoritesList');
                const items = (data.data || []).map(it => {
                    const code = it.stock_code || '';
                    const name = it.stock_name || '';
                    return `<span class="stock-tag" onclick="quickSearch('${code}')">${code} ${name}</span>`;
                }).join(' ');
                listEl.innerHTML = items ? `<div style="margin-top:8px; color:#666;">æˆ‘çš„æœ€æ„›ï¼š</div><div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;">${items}</div>` : '<div style="margin-top:8px; color:#999;">å°šç„¡æœ€æ„›</div>';
            } catch (e) {
                alert('è®€å–æœ€æ„›å¤±æ•—ï¼š' + e.message);
            }
        }

        function parseNumber(value) {
            if (value === null || value === undefined) return null;
            const v = String(value).replace(/,/g, '').trim();
            if (v === '-' || v === '' || v.toLowerCase() === 'nan') return null;
            const n = Number(v);
            return isNaN(n) ? null : n;
        }

        function normalizeDate(d) {
            // å°‡ 2025/01/02 æˆ– 114/01/02 æ ¼å¼è½‰ç‚º Date ç‰©ä»¶æˆ–å­—ä¸²
            // ç›´æ¥å›å‚³åŸå­—ä¸²ä»¥ä¾› X è»¸é¡ç›®é¡¯ç¤º
            return String(d).replace(/\./g, '/');
        }

        function renderKline(historyData) {
            try {
                const raw = historyData.data; // æ¯åˆ—: [æ—¥æœŸ, æˆäº¤è‚¡æ•¸, æˆäº¤é‡‘é¡, é–‹ç›¤åƒ¹, æœ€é«˜åƒ¹, æœ€ä½åƒ¹, æ”¶ç›¤åƒ¹, æ¼²è·Œåƒ¹å·®, æˆäº¤ç­†æ•¸]
                // å–æœ€è¿‘ 60 ç­†ï¼ˆè‹¥ä¸è¶³å‰‡å…¨å–ï¼‰ï¼Œä¸¦ä¾æ™‚é–“å…ˆå¾Œæ’åº
                const rows = raw.slice(-60);
                const dates = rows.map(r => normalizeDate(r[0]));
                const ohlc = rows.map(r => [
                    parseNumber(r[3]), // é–‹
                    parseNumber(r[6]), // æ”¶
                    parseNumber(r[4]), // é«˜
                    parseNumber(r[5])  // ä½
                ]);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#ffffff',
                    grid: { left: 40, right: 20, top: 10, bottom: 40 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        valueFormatter: (v) => (v == null ? '-' : v)
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        boundaryGap: true,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' }
                    },
                    yAxis: {
                        scale: true,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' },
                        splitLine: { lineStyle: { color: 'rgba(0,0,0,0.08)' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: 'Kç·š',
                            type: 'candlestick',
                            data: ohlc,
                            itemStyle: {
                                color: '#e74c3c',      // æ¼²ï¼ˆæ”¶>=é–‹ï¼‰ç”¨ç´…
                                color0: '#27ae60',     // è·Œï¼ˆæ”¶<é–‹ï¼‰ç”¨ç¶ 
                                borderColor: '#e74c3c',
                                borderColor0: '#27ae60'
                            }
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render K-line error:', e);
            }
        }

        // Enter éµæœå°‹
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });
    </script>
</body>
</html>
