<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§é¸è‚¡é«˜æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .search-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            margin-bottom: 30px;
            border: 1px solid #2d2d44;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-input {
            flex: 0 0 220px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            outline: none;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .auth-panel {
            background: #252538;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            max-width: 400px;
            margin: 0 auto 20px;
            border: 1px solid #3a3a52;
        }

        .auth-panel h3 {
            margin-bottom: 15px;
            color: #c0c0c0;
        }

        .auth-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .auth-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 127, 199, 0.5);
        }

        .admin-badge {
            display: inline-block;
            background: #e85d75;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        /* Scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a6fa5;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a7fc7;
        }

        .lang-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            padding: 8px 16px;
            background: #2a2a3e;
            border: 2px solid #5a7fc7;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            color: #5a7fc7;
        }

        .lang-btn.active {
            background: #5a7fc7;
            color: white;
        }

        .lang-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 199, 0.5);
        }

        .search-input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .search-input:focus {
            border-color: #5a7fc7;
            box-shadow: 0 0 0 3px rgba(90, 127, 199, 0.3);
        }

        .search-btn {
            padding: 15px 30px;
            font-size: 16px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 127, 199, 0.5);
        }

        .popular-stocks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stock-tag {
            padding: 8px 15px;
            background: #2a2a3e;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #7a9fd7;
            border: 1px solid #3a3a52;
        }

        .stock-tag:hover {
            background: #5a7fc7;
            color: white;
            transform: scale(1.05);
        }

        .result-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: none;
            border: 1px solid #2d2d44;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stock-info {
            margin-bottom: 30px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .stock-title {
            font-size: 1.8em;
            color: #e0e0e0;
        }

        .stock-code {
            color: #999;
            font-size: 0.8em;
        }

        .price-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-card {
            padding: 20px;
            background: #2a2a3e;
            border-radius: 10px;
            border-left: 4px solid #5a7fc7;
        }

        .price-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #e0e0e0;
        }

        .price-value.up {
            color: #e74c3c;
        }

        .price-value.down {
            color: #27ae60;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3a3a52;
            color: #e0e0e0;
        }

        .history-table th {
            background: #4a6fa5;
            color: white;
            font-weight: bold;
        }

        .history-table tr:hover {
            background: #2a2a3e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            padding: 20px;
            background: #3a1f1f;
            border-left: 4px solid #e85d75;
            border-radius: 5px;
            color: #ff8a9a;
        }

        .update-time {
            text-align: right;
            color: #999;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a52;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #5a7fc7;
        }

        .tab.active {
            color: #5a7fc7;
            border-bottom-color: #5a7fc7;
        } show">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('search')">ğŸ“Š æŸ¥è©¢è‚¡ç¥¨</button>
                <button class="tab" onclick="switchTab('watchlist')">â­ é—œæ³¨æ¸…å–®</button>
                <button class="tab" onclick="switchTab('history')">ğŸ• æŸ¥è©¢æ­·å²</button>
            </div>

            <div id="searchTab" class="tab-content active">
                <div id="resultContent"></div>
            </div>

            <div id="watchlistTab" class="tab-content">
                <div class="add-form">
                    <h3 style="margin-bottom: 15px;">â• æ·»åŠ è‚¡ç¥¨åˆ°é—œæ³¨æ¸…å–®</h3>
                    <div class="form-group">
                        <label class="form-label">è‚¡ç¥¨ä»£ç¢¼</label>
                        <input type="text" class="form-input" id="addStockCode" placeholder="ä¾‹å¦‚ï¼š2330">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”¢æ¥­åˆ†é¡</label>
                        <select class="form-select" id="addCategory">
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addToWatchlist()">æ·»åŠ åˆ°é—œæ³¨æ¸…å–®</button>
                </div>

                <div class="category-filter" id="categoryFilter">
                    <button class="category-btn active" onclick="filterWatchlist('')">å…¨éƒ¨</button>
                </div>

                <div class="watchlist-grid" id="watchlistGrid"></div>
            </div>

            <div id="historyTab" class="tab-content">
                <h3 style="margin-bottom: 15px;">æœ€è¿‘æŸ¥è©¢è¨˜éŒ„</h3>
                <div class="history-list" id="historyList"></div>
            
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .watchlist-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .watchlist-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .watchlist-code {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .watchlist-name {
            color: #666;
            font-size: 0.9em;
        }

        .watchlist-category {
            display: inline-block;
            padding: 3px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .history-info {
            flex: 1;
        }

        .history-time {
            color: #999;
            font-size: 0.85em;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background: #e0e0e0;
        }

        let currentCategory = '';

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadWatchlist();
            loadHistory();
        });

        function switchTab(tab) {
            // æ›´æ–° tab æ¨£å¼
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tab === 'watchlist') {
                loadWatchlist();
            } else if (tab === 'history') {
                loadHistory();
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('addCategory');
                    const filter = document.getElementById('categoryFilter');
                    
                    data.data.forEach(cat => {
                        // æ·»åŠ åˆ°é¸æ“‡æ¡†
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        select.appendChild(option);
                        
                        // æ·»åŠ åˆ°éæ¿¾æŒ‰éˆ•
                        const btn = document.createElement('button');
                        btn.className = 'category-btn';
                        btn.textContent = cat;
                        btn.onclick = () => filterWatchlist(cat);
                        filter.appendChild(btn);
                    });
            // åˆ‡æ›åˆ°æŸ¥è©¢é ç±¤
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('searchTab').classList.add('active');

            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    return;
                }

                // å„²å­˜æŸ¥è©¢æ­·å²
                saveSearchHistory(stockCode, infoData.stock_name);f (data.success && data.data.length > 0) {
                    grid.innerHTML = data.data.map(item => `
                        <div class="watchlist-card" onclick="searchStockById('${item.stock_code}')">
                            <div class="watchlist-header">
                                <div>
                                    <div class="watchlist-code">${item.stock_code}</div>
                                    <div class="watchlist-name">${item.stock_name || 'è¼‰å…¥ä¸­...'}</div>
                                    <span class="watchlist-category">${item.category}</span>
                                </div>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteFromWatchlist(${item.id})">åˆªé™¤</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡é—œæ³¨è‚¡ç¥¨</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥é—œæ³¨æ¸…å–®å¤±æ•—:', error);
            }
        }

        function filterWatchlist(category) {
            currentCategory = category;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((category === '' && btn.textContent === 'å…¨éƒ¨') || btn.textContent === category) {
                    btn.classList.add('active');
                }
            });
            
            loadWatchlist(category);
        }

        async function addToWatchlist() {
            const stockCode = document.getElementById('addStockCode').value.trim();
            const category = document.getElementById('addCategory').value;
            
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            if (!category) {
                alert('è«‹é¸æ“‡ç”¢æ¥­åˆ†é¡');
                return;
            }
            
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, category: category })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('addStockCode').value = '';
                    document.getElementById('addCategory').value = '';
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'æ·»åŠ å¤±æ•—');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±æ•—: ' + error.message);
            }
        }

        async function deleteFromWatchlist(id) {
            if (!confirm('ç¢ºå®šè¦å¾é—œæ³¨æ¸…å–®ä¸­ç§»é™¤æ­¤è‚¡ç¥¨å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/watchlist/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadWatchlist(currentCategory);
                } else {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                
                const list = document.getElementById('historyList');
                
                if (data.success && data.data.length > 0) {
                    list.innerHTML = data.data.map(item => `
                        <div class="history-item" onclick="searchStockById('${item.stock_code}')">
                            <div class="history-info">
                                <div><strong>${item.stock_code}</strong> ${item.stock_name || ''}</div>
                                <div class="history-time">${new Date(item.search_time).toLocaleString('zh-TW')}</div>
                            </div>
                            <span>â†’</span>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">å°šç„¡æŸ¥è©¢è¨˜éŒ„</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        async function saveSearchHistory(stockCode, stockName) {
            try {
                await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_code: stockCode, stock_name: stockName })
                });
            } catch (error) {
                console.error('å„²å­˜æ­·å²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        function searchStockById(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            switchTab('search');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            searchStock();
        }

        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .kline {
            width: 100%;
            height: 420px;
            margin-top: 20px;
            background: #fff;
            border-radius: 10px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .chart-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-btn:hover {
            transform: translateY(-2px);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .news-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .news-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
        }

        .news-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
            transition: all 0.3s;
        }

        .news-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .news-item a {
            text-decoration: none;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .news-item a:hover {
            color: #667eea;
        }

        .news-date {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .news-source {
            display: inline-block;
            font-size: 11px;
            color: #667eea;
            background: #e8ecff;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="switchLanguage('zh')" id="langZh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLanguage('en')" id="langEn">English</button>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å°è‚¡å³æ™‚æŸ¥è©¢ç³»çµ±</h1>
            <p>è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢å³æ™‚è³‡è¨Šèˆ‡æ­·å²è³‡æ–™</p>
        </div>

        <div id="authPanel" class="auth-panel">
            <h3>ğŸ” ç™»å…¥ / è¨»å†Š</h3>
            <input type="text" class="auth-input" id="authUserId" placeholder="ä½¿ç”¨è€… ID">
            <input type="password" class="auth-input" id="authPassword" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰">
            <button class="auth-btn" onclick="handleLogin()">ğŸ”‘ ç™»å…¥</button>
            <button class="auth-btn" onclick="handleRegister()">âœ¨ è¨»å†Š</button>
        </div>

        <div class="search-box hidden" id="mainPanel">
            <div class="user-form">
                <div style="flex:1; display:flex; align-items:center;">
                    <span style="font-weight:bold; color:#333;">æ­¡è¿ï¼Œ<span id="currentUser"></span></span>
                    <span id="adminBadge" class="admin-badge hidden">ç®¡ç†å“¡</span>
                </div>
                <button class="search-btn" onclick="loadMyFavorites()">ğŸ’– è¼‰å…¥æˆ‘çš„æœ€æ„›</button>
                <button class="search-btn" onclick="handleLogout()">ğŸšª ç™»å‡º</button>
            </div>
            <div class="search-form">
                <input type="text" class="search-input" id="stockInput" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰">
                <button class="search-btn" onclick="searchStock()">æŸ¥è©¢</button>
            </div>
            <div class="popular-stocks">
                <span style="color: #666; margin-right: 10px;">ç†±é–€è‚¡ç¥¨ï¼š</span>
                <div class="stock-tag" onclick="quickSearch('2330')">2330 å°ç©é›»</div>
                <div class="stock-tag" onclick="quickSearch('2317')">2317 é´»æµ·</div>
                <div class="stock-tag" onclick="quickSearch('2454')">2454 è¯ç™¼ç§‘</div>
                <div class="stock-tag" onclick="quickSearch('2412')">2412 ä¸­è¯é›»</div>
                <div class="stock-tag" onclick="quickSearch('2882')">2882 åœ‹æ³°é‡‘</div>
                <div class="stock-tag" onclick="quickSearch('2303')">2303 è¯é›»</div>
            </div>
        </div>

        <div class="result-box" id="resultBox">
            <div id="resultContent"></div>
            <div class="chart-controls" id="chartControls" style="display:none;">
                <button class="chart-btn active" onclick="switchChart('kline')">ğŸ“Š Kç·šåœ–</button>
                <button class="chart-btn" onclick="switchChart('line')">ğŸ“ˆ é«˜ä½æ›²ç·š</button>
            </div>
            <div class="content-grid" id="contentGrid" style="display:none;">
                <div>
                    <div id="kline" class="kline"></div>
                </div>
                <div class="news-panel" id="newsPanel">
                    <h3>ğŸ“° ç›¸é—œæ–°è</h3>
                    <div id="newsList">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div id="favoritesList" style="margin-top: 16px;"></div>
        </div>
    </div>

    <!-- ECharts CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        let klineChart = null;
        let currentSession = { userId: null, isAdmin: false };
        let currentLang = 'zh';

        const i18n = {
            zh: {
                // Header
                systemTitle: 'ğŸ¤– AI æ™ºæ…§é¸è‚¡é«˜æ‰‹',
                systemDesc: 'é‹ç”¨ AI æŠ€è¡“è¼”åŠ©æ‚¨çš„æŠ•è³‡æ±ºç­–ï¼Œè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æŸ¥è©¢å³æ™‚è³‡è¨Šèˆ‡æ­·å²è³‡æ–™',
                // Auth
                loginRegister: 'ğŸ” ç™»å…¥ / è¨»å†Š',
                userId: 'ä½¿ç”¨è€… ID',
                password: 'å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰',
                login: 'ğŸ”‘ ç™»å…¥',
                register: 'âœ¨ è¨»å†Š',
                logout: 'ğŸšª ç™»å‡º',
                welcome: 'æ­¡è¿ï¼Œ',
                admin: 'ç®¡ç†å“¡',
                // Search
                stockCodePlaceholder: 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰',
                search: 'æŸ¥è©¢',
                popularStocks: 'ç†±é–€è‚¡ç¥¨ï¼š',
                loadFavorites: 'ğŸ’– è¼‰å…¥æˆ‘çš„æœ€æ„›',
                // Stock info
                currentPrice: 'ç›®å‰åƒ¹æ ¼',
                openPrice: 'é–‹ç›¤åƒ¹',
                highPrice: 'æœ€é«˜åƒ¹',
                lowPrice: 'æœ€ä½åƒ¹',
                volume: 'æˆäº¤é‡',
                addFavorite: 'åŠ å…¥æœ€æ„›',
                monthlyHistory: 'æœ¬æœˆæ­·å²è³‡æ–™',
                updateTime: 'æ›´æ–°æ™‚é–“',
                // Charts
                klineChart: 'ğŸ“Š Kç·šåœ–',
                lineChart: 'ğŸ“ˆ é«˜ä½æ›²ç·š',
                highLowLine: 'æ­·å²é«˜ä½æ›²ç·š',
                highLabel: 'æœ€é«˜åƒ¹',
                lowLabel: 'æœ€ä½åƒ¹',
                closeLabel: 'æ”¶ç›¤åƒ¹',
                // News
                relatedNews: 'ğŸ“° ç›¸é—œæ–°è',
                loading: 'è¼‰å…¥ä¸­...',
                noNews: 'æš«ç„¡ç›¸é—œæ–°è',
                loadNewsFailed: 'è¼‰å…¥æ–°èå¤±æ•—',
                // Favorites
                myFavorites: 'æˆ‘çš„æœ€æ„›ï¼š',
                noFavorites: 'å°šç„¡æœ€æ„›',
                adminMode: 'ğŸ‘‘ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‰€æœ‰ä½¿ç”¨è€…çš„æœ€æ„›',
                // Messages
                pleaseLogin: 'è«‹å…ˆç™»å…¥',
                pleaseEnterUserId: 'è«‹è¼¸å…¥ä½¿ç”¨è€… ID èˆ‡å¯†ç¢¼',
                passwordMinLength: 'å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ',
                pleaseEnterStockCode: 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼',
                addFavSuccess: 'å·²æˆåŠŸæ·»åŠ åˆ°æœ€æ„›',
                addFavFailed: 'åŠ å…¥æœ€æ„›å¤±æ•—',
                loadFavFailed: 'è®€å–æœ€æ„›å¤±æ•—',
                registerSuccess: 'è¨»å†ŠæˆåŠŸ',
                registerFailed: 'è¨»å†Šå¤±æ•—',
                loginSuccess: 'ç™»å…¥æˆåŠŸ',
                loginFailed: 'ç™»å…¥å¤±æ•—'
            },
            en: {
                // Header
                systemTitle: 'ğŸ¤– AI Smart Stock Picker',
                systemDesc: 'AI-powered investment decision assistant. Enter stock code to query real-time information and historical data',
                // Auth
                loginRegister: 'ğŸ” Login / Register',
                userId: 'User ID',
                password: 'Password (min 6 chars)',
                login: 'ğŸ”‘ Login',
                register: 'âœ¨ Register',
                logout: 'ğŸšª Logout',
                welcome: 'Welcome, ',
                admin: 'Admin',
                // Search
                stockCodePlaceholder: 'Enter stock code (e.g., 2330)',
                search: 'Search',
                popularStocks: 'Popular Stocks:',
                loadFavorites: 'ğŸ’– Load My Favorites',
                // Stock info
                currentPrice: 'Current Price',
                openPrice: 'Open',
                highPrice: 'High',
                lowPrice: 'Low',
                volume: 'Volume',
                addFavorite: 'Add to Favorites',
                monthlyHistory: 'Monthly Historical Data',
                updateTime: 'Updated',
                // Charts
                klineChart: 'ğŸ“Š K-Line',
                lineChart: 'ğŸ“ˆ High-Low Line',
                highLowLine: 'Historical High-Low Line',
                highLabel: 'High',
                lowLabel: 'Low',
                closeLabel: 'Close',
                // News
                relatedNews: 'ğŸ“° Related News',
                loading: 'Loading...',
                noNews: 'No related news',
                loadNewsFailed: 'Failed to load news',
                // Favorites
                myFavorites: 'My Favorites:',
                noFavorites: 'No favorites yet',
                adminMode: 'ğŸ‘‘ Admin Mode: All Users\' Favorites',
                // Messages
                pleaseLogin: 'Please login first',
                pleaseEnterUserId: 'Please enter user ID and password',
                passwordMinLength: 'Password must be at least 6 characters',
                pleaseEnterStockCode: 'Please enter stock code',
                addFavSuccess: 'Successfully added to favorites',
                addFavFailed: 'Failed to add to favorites',
                loadFavFailed: 'Failed to load favorites',
                registerSuccess: 'Registration successful',
                registerFailed: 'Registration failed',
                loginSuccess: 'Login successful',
                loginFailed: 'Login failed'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.getElementById('langZh').classList.toggle('active', lang === 'zh');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            updateUILanguage();
        }

        function updateUILanguage() {
            // Header
            document.querySelector('.header h1').textContent = t('systemTitle');
            document.querySelector('.header p').textContent = t('systemDesc');
            
            // Auth panel
            const authTitle = document.querySelector('#authPanel h3');
            if (authTitle) authTitle.textContent = t('loginRegister');
            document.getElementById('authUserId').placeholder = t('userId');
            document.getElementById('authPassword').placeholder = t('password');
            document.querySelectorAll('#authPanel .auth-btn')[0].textContent = t('login');
            document.querySelectorAll('#authPanel .auth-btn')[1].textContent = t('register');
            
            // Main panel
            const adminBadge = document.getElementById('adminBadge');
            if (adminBadge && !adminBadge.classList.contains('hidden')) {
                adminBadge.textContent = t('admin');
            }
            const loadFavBtn = document.querySelector('#mainPanel .search-btn');
            if (loadFavBtn) loadFavBtn.textContent = t('loadFavorites');
            const logoutBtn = document.querySelectorAll('#mainPanel .search-btn')[1];
            if (logoutBtn) logoutBtn.textContent = t('logout');
            
            // Search
            document.getElementById('stockInput').placeholder = t('stockCodePlaceholder');
            document.querySelector('.search-form .search-btn').textContent = t('search');
            document.querySelector('.popular-stocks span').textContent = t('popularStocks');
            
            // Chart buttons
            const chartBtns = document.querySelectorAll('.chart-btn');
            if (chartBtns[0]) chartBtns[0].textContent = t('klineChart');
            if (chartBtns[1]) chartBtns[1].textContent = t('lineChart');
            
            // News panel
            const newsTitle = document.querySelector('#newsPanel h3');
            if (newsTitle) newsTitle.textContent = t('relatedNews');
        }

        async function handleRegister() {
            const userId = document.getElementById('authUserId').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            if (!userId || !password) {
                alert(t('pleaseEnterUserId'));
                return;
            }
            if (password.length < 6) {
                alert(t('passwordMinLength'));
                return;
            }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                alert(data.message);
                // è¨»å†Šå¾Œè‡ªå‹•ç™»å…¥
                currentSession = { userId: userId, isAdmin: data.is_admin };
                updateUIAfterLogin();
            } catch (e) {
                alert('è¨»å†Šå¤±æ•—ï¼š' + e.message);
            }
        }

        async function handleLogin() {
            const userId = document.getElementById('authUserId').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            if (!userId || !password) {
                alert(t('pleaseEnterUserId'));
                return;
            }
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                updateUIAfterLogin();
                alert(data.message);
            } catch (e) {
                alert('ç™»å…¥å¤±æ•—ï¼š' + e.message);
            }
        }

        function handleLogout() {
            currentSession = { userId: null, isAdmin: false };
            document.getElementById('authPanel').classList.remove('hidden');
            document.getElementById('mainPanel').classList.add('hidden');
            document.getElementById('resultBox').classList.remove('show');
            document.getElementById('authUserId').value = '';
            document.getElementById('authPassword').value = '';
        }

        function updateUIAfterLogin() {
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentSession.userId;
            if (currentSession.isAdmin) {
                document.getElementById('adminBadge').classList.remove('hidden');
            } else {
                document.getElementById('adminBadge').classList.add('hidden');
            }
        }

        function quickSearch(stockCode) {
            document.getElementById('stockInput').value = stockCode;
            searchStock();
        }

        async function searchStock() {
            const stockCode = document.getElementById('stockInput').value.trim();
            if (!stockCode) {
                alert(t('pleaseEnterStockCode'));
                return;
            }

            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultBox.classList.add('show');
            resultContent.innerHTML = '<div class="loading">ğŸ”„ è¼‰å…¥ä¸­...</div>';

            try {
                // ç²å–å³æ™‚è³‡è¨Š
                const infoResponse = await fetch(`/api/stock/${stockCode}`);
                const infoData = await infoResponse.json();

                if (!infoData.success) {
                    resultContent.innerHTML = `<div class="error">${infoData.message}</div>`;
                    return;
                }

                // ç²å–æ­·å²è³‡æ–™
                const historyResponse = await fetch(`/api/stock/history/${stockCode}`);
                const historyData = await historyResponse.json();

                displayResult(infoData, historyData);
            } catch (error) {
                resultContent.innerHTML = `<div class="error">ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }

        function displayResult(infoData, historyData) {
            let html = '<div class="stock-info">';
            
            // è‚¡ç¥¨æ¨™é¡Œ
            html += `
                <div class="stock-header">
                    <div>
                        <div class="stock-title">${infoData.stock_name}</div>
                        <div class="stock-code">è‚¡ç¥¨ä»£ç¢¼: ${infoData.stock_code}</div>
                    </div>
                    <div>
                        <button class="search-btn" style="padding:10px 16px" onclick="addToFavorites('${infoData.stock_code}', '${infoData.stock_name}')">åŠ å…¥æœ€æ„›</button>
                    </div>
                </div>
            `;

            // åƒ¹æ ¼è³‡è¨Š
            const priceChangeClass = parseFloat(infoData.current_price) >= parseFloat(infoData.change) ? 'up' : 'down';
            html += `
                <div class="price-info">
                    <div class="price-card">
                        <div class="price-label">ç›®å‰åƒ¹æ ¼</div>
                        <div class="price-value ${priceChangeClass}">${infoData.current_price}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">é–‹ç›¤åƒ¹</div>
                        <div class="price-value">${infoData.open}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€é«˜åƒ¹</div>
                        <div class="price-value">${infoData.high}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æœ€ä½åƒ¹</div>
                        <div class="price-value">${infoData.low}</div>
                    </div>
                    <div class="price-card">
                        <div class="price-label">æˆäº¤é‡</div>
                        <div class="price-value">${infoData.volume}</div>
                    </div>
                </div>
            `;

            // æ­·å²è³‡æ–™è¡¨æ ¼
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                html += '<h3>æœ¬æœˆæ­·å²è³‡æ–™</h3>';
                html += '<table class="history-table"><thead><tr>';
                
                historyData.fields.forEach(field => {
                    html += `<th>${field}</th>`;
                });
                html += '</tr></thead><tbody>';

                // åªé¡¯ç¤ºæœ€è¿‘10ç­†è³‡æ–™
                const recentData = historyData.data.slice(-10).reverse();
                recentData.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${cell}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            html += `<div class="update-time">æ›´æ–°æ™‚é–“: ${infoData.time || new Date().toLocaleString('zh-TW')}</div>`;
            html += '</div>';

            document.getElementById('resultContent').innerHTML = html;

            // é¡¯ç¤ºåœ–è¡¨æ§åˆ¶èˆ‡æ–°èé¢æ¿
            document.getElementById('chartControls').style.display = 'flex';
            document.getElementById('contentGrid').style.display = 'grid';

            // è¼‰å…¥æ–°è
            loadStockNews(infoData.stock_code);

            // ç¹ªè£½ K ç·šåœ–ï¼ˆè‹¥æœ‰æ­·å²è³‡æ–™ï¼‰
            if (historyData.success && historyData.data && historyData.data.length > 0) {
                window.currentHistoryData = historyData; // ä¿å­˜è³‡æ–™ä¾›åˆ‡æ›åœ–è¡¨ç”¨
                renderKline(historyData);
            }
        }

        let currentChartType = 'kline';

        function switchChart(chartType) {
            currentChartType = chartType;
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (!window.currentHistoryData) return;
            
            if (chartType === 'kline') {
                renderKline(window.currentHistoryData);
            } else {
                renderLineChart(window.currentHistoryData);
            }
        }

        async function loadStockNews(stockCode) {
            try {
                document.getElementById('newsList').innerHTML = 'è¼‰å…¥ä¸­...';
                const res = await fetch(`/api/news/${stockCode}`);
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    document.getElementById('newsList').innerHTML = '<p style="color:#999;">æš«ç„¡ç›¸é—œæ–°è</p>';
                    return;
                }
                
                let newsHtml = '';
                data.data.forEach(news => {
                    newsHtml += `
                        <div class="news-item">
                            <a href="${news.link}" target="_blank">${news.title}</a>
                            <div class="news-date">${news.date}</div>
                            <span class="news-source">${news.source}</span>
                        </div>
                    `;
                });
                document.getElementById('newsList').innerHTML = newsHtml;
            } catch (e) {
                document.getElementById('newsList').innerHTML = '<p style="color:#e74c3c;">è¼‰å…¥æ–°èå¤±æ•—</p>';
            }
        }

        async function addToFavorites(stockCode, stockName) {
            if (!currentSession.userId) {
                alert(t('pleaseLogin'));
                return;
            }
            try {
                const res = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentSession.userId, stock_code: stockCode, stock_name: stockName })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'åŠ å…¥æœ€æ„›å¤±æ•—');
                await loadMyFavorites();
            } catch (e) {
                alert('åŠ å…¥æœ€æ„›å¤±æ•—ï¼š' + e.message);
            }
        }

        async function loadMyFavorites() {
            if (!currentSession.userId) {
                alert(t('pleaseLogin'));
                return;
            }
            try {
                const res = await fetch(`/api/favorites?user_id=${encodeURIComponent(currentSession.userId)}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message || 'è®€å–æœ€æ„›å¤±æ•—');
                const listEl = document.getElementById('favoritesList');
                
                if (data.is_admin) {
                    // ç®¡ç†å“¡ï¼šæŒ‰ä½¿ç”¨è€…åˆ†çµ„é¡¯ç¤º
                    const grouped = {};
                    (data.data || []).forEach(it => {
                        const uid = it.user_id || 'unknown';
                        if (!grouped[uid]) grouped[uid] = [];
                        grouped[uid].push(it);
                    });
                    let html = '<div style="margin-top:8px; color:#666; font-weight:bold;">ğŸ‘‘ ç®¡ç†å“¡æ¨¡å¼ï¼šæ‰€æœ‰ä½¿ç”¨è€…çš„æœ€æ„›</div>';
                    for (const uid in grouped) {
                        html += `<div style="margin-top:12px; color:#555; font-weight:bold;">ğŸ‘¤ ${uid}</div>`;
                        html += '<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;">';
                        grouped[uid].forEach(it => {
                            const code = it.stock_code || '';
                            const name = it.stock_name || '';
                            html += `<span class="stock-tag" onclick="quickSearch('${code}')">${code} ${name}</span>`;
                        });
                        html += '</div>';
                    }
                    listEl.innerHTML = html;
                } else {
                    // ä¸€èˆ¬ä½¿ç”¨è€…
                    const items = (data.data || []).map(it => {
                        const code = it.stock_code || '';
                        const name = it.stock_name || '';
                        return `<span class="stock-tag" onclick="quickSearch('${code}')">${code} ${name}</span>`;
                    }).join(' ');
                    listEl.innerHTML = items ? `<div style="margin-top:8px; color:#666;">æˆ‘çš„æœ€æ„›ï¼š</div><div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;">${items}</div>` : '<div style="margin-top:8px; color:#999;">å°šç„¡æœ€æ„›</div>';
                }
            } catch (e) {
                alert('è®€å–æœ€æ„›å¤±æ•—ï¼š' + e.message);
            }
        }

        function parseNumber(value) {
            if (value === null || value === undefined) return null;
            const v = String(value).replace(/,/g, '').trim();
            if (v === '-' || v === '' || v.toLowerCase() === 'nan') return null;
            const n = Number(v);
            return isNaN(n) ? null : n;
        }

        function normalizeDate(d) {
            // å°‡ 2025/01/02 æˆ– 114/01/02 æ ¼å¼è½‰ç‚º Date ç‰©ä»¶æˆ–å­—ä¸²
            // ç›´æ¥å›å‚³åŸå­—ä¸²ä»¥ä¾› X è»¸é¡ç›®é¡¯ç¤º
            return String(d).replace(/\./g, '/');
        }

        function renderKline(historyData) {
            try {
                const raw = historyData.data; // æ¯åˆ—: [æ—¥æœŸ, æˆäº¤è‚¡æ•¸, æˆäº¤é‡‘é¡, é–‹ç›¤åƒ¹, æœ€é«˜åƒ¹, æœ€ä½åƒ¹, æ”¶ç›¤åƒ¹, æ¼²è·Œåƒ¹å·®, æˆäº¤ç­†æ•¸]
                // å–æœ€è¿‘ 60 ç­†ï¼ˆè‹¥ä¸è¶³å‰‡å…¨å–ï¼‰ï¼Œä¸¦ä¾æ™‚é–“å…ˆå¾Œæ’åº
                const rows = raw.slice(-60);
                const dates = rows.map(r => normalizeDate(r[0]));
                const ohlc = rows.map(r => [
                    parseNumber(r[3]), // é–‹
                    parseNumber(r[6]), // æ”¶
                    parseNumber(r[4]), // é«˜
                    parseNumber(r[5])  // ä½
                ]);

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#ffffff',
                    grid: { left: 40, right: 20, top: 10, bottom: 40 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' },
                        valueFormatter: (v) => (v == null ? '-' : v)
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        boundaryGap: true,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' }
                    },
                    yAxis: {
                        scale: true,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' },
                        splitLine: { lineStyle: { color: 'rgba(0,0,0,0.08)' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: 'Kç·š',
                            type: 'candlestick',
                            data: ohlc,
                            itemStyle: {
                                color: '#e74c3c',      // æ¼²ï¼ˆæ”¶>=é–‹ï¼‰ç”¨ç´…
                                color0: '#27ae60',     // è·Œï¼ˆæ”¶<é–‹ï¼‰ç”¨ç¶ 
                                borderColor: '#e74c3c',
                                borderColor0: '#27ae60'
                            }
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render K-line error:', e);
            }
        }

        function renderLineChart(historyData) {
            try {
                const raw = historyData.data;
                const rows = raw.slice(-60);
                const dates = rows.map(r => normalizeDate(r[0]));
                const highs = rows.map(r => parseNumber(r[4])); // æœ€é«˜åƒ¹
                const lows = rows.map(r => parseNumber(r[5]));  // æœ€ä½åƒ¹
                const closes = rows.map(r => parseNumber(r[6])); // æ”¶ç›¤åƒ¹

                const el = document.getElementById('kline');
                if (!el) return;
                if (klineChart) {
                    klineChart.dispose();
                }
                klineChart = echarts.init(el);

                const option = {
                    animation: true,
                    backgroundColor: '#ffffff',
                    title: { text: 'æ­·å²é«˜ä½æ›²ç·š', left: 'center', textStyle: { fontSize: 16, color: '#333' } },
                    grid: { left: 50, right: 30, top: 50, bottom: 40 },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' }
                    },
                    legend: {
                        data: ['æœ€é«˜åƒ¹', 'æœ€ä½åƒ¹', 'æ”¶ç›¤åƒ¹'],
                        top: 25
                    },
                    xAxis: {
                        type: 'category',
                        data: dates,
                        boundaryGap: false,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true,
                        axisLine: { lineStyle: { color: '#888' } },
                        axisLabel: { color: '#555' },
                        splitLine: { lineStyle: { color: 'rgba(0,0,0,0.08)' } }
                    },
                    dataZoom: [
                        { type: 'inside', start: 40, end: 100 },
                        { start: 40, end: 100 }
                    ],
                    series: [
                        {
                            name: 'æœ€é«˜åƒ¹',
                            type: 'line',
                            data: highs,
                            smooth: true,
                            lineStyle: { color: '#e74c3c', width: 2 },
                            itemStyle: { color: '#e74c3c' }
                        },
                        {
                            name: 'æœ€ä½åƒ¹',
                            type: 'line',
                            data: lows,
                            smooth: true,
                            lineStyle: { color: '#27ae60', width: 2 },
                            itemStyle: { color: '#27ae60' }
                        },
                        {
                            name: 'æ”¶ç›¤åƒ¹',
                            type: 'line',
                            data: closes,
                            smooth: true,
                            lineStyle: { color: '#667eea', width: 2 },
                            itemStyle: { color: '#667eea' }
                        }
                    ]
                };

                klineChart.setOption(option);
                window.addEventListener('resize', () => {
                    if (klineChart) klineChart.resize();
                });
            } catch (e) {
                console.error('Render line chart error:', e);
            }
        }

        // Enter éµæœå°‹
        document.getElementById('stockInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStock();
            }
        });
    </script>
</body>
</html>
