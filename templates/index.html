<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Êô∫ÊÖßÈÅ∏ËÇ°È´òÊâã</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .app-version {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .auth-panel {
            background: #252538;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            max-width: 400px;
            margin: 0 auto 20px;
            border: 1px solid #3a3a52;
        }

        .auth-panel h2 {
            margin-bottom: 20px;
            color: #c0c0c0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
        }

        .form-group input:focus {
            border-color: #5a7fc7;
            box-shadow: 0 0 0 3px rgba(90, 127, 199, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 199, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .main-panel {
            display: none;
        }

        .main-panel.show {
            display: block;
        }

        .search-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            margin-bottom: 30px;
            border: 1px solid #2d2d44;
        }

        .user-info {
            background: #252538;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #3a3a52;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info span {
            font-weight: bold;
            color: #5a7fc7;
        }

        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 8px 20px;
            width: auto;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
        }

        .search-form input:focus {
            border-color: #5a7fc7;
        }

        .search-form button {
            padding: 12px 30px;
            white-space: nowrap;
        }

        .result-panel {
            background: #252538;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3a3a52;
            margin-top: 20px;
        }

        .stock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
        }

        .positive {
            color: #26a69a;
        }

        .negative {
            color: #ef5350;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #3a3a52;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a52;
            padding-bottom: 10px;
        }

        .tab {
            padding: 8px 16px;
            background: #252538;
            border: 1px solid #3a3a52;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4a6fa5;
            border-bottom-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error {
            background: #c0392b;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .favorites-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .favorite-item {
            background: #1a1a2e;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorite-item:hover {
            background: #4a6fa5;
        }

        .tech-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .indicator-item {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .indicator-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 3px;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .left-panel {
            min-width: 0;
        }

        .right-panel {
            background: #1e1e2e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 1px solid #2d2d44;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .favorites-panel h3 {
            margin-bottom: 15px;
            color: #5a7fc7;
            font-size: 1.2em;
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-favorite-form {
            display: none;
            background: #252538;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #3a3a52;
        }

        .add-favorite-form.show {
            display: block;
        }

        .add-favorite-form input {
            width: 100%;
            padding: 8px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
            margin-bottom: 10px;
        }

        .add-favorite-form button {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .favorites-list-panel {
            max-height: 500px;
            overflow-y: auto;
        }

        .favorite-item-panel {
            background: #252538;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .favorite-item-panel:hover {
            background: #2d2d44;
            transform: translateX(-2px);
        }

        .favorite-info {
            flex: 1;
            cursor: pointer;
        }

        .favorite-code {
            font-weight: bold;
            color: #5a7fc7;
            font-size: 14px;
        }

        .favorite-name {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #229954;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .right-panel {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà AI Êô∫ÊÖßÈÅ∏ËÇ°È´òÊâã</h1>
            <p class="app-version">v3.0 - ÊäÄË°ìÂàÜÊûêÂ∞àÊ•≠Áâà</p>
        </div>

        <!-- ÁôªÂÖ•Èù¢Êùø -->
        <div id="authPanel" class="auth-panel">
            <h2>üîê ÁôªÂÖ• / Ë®ªÂÜä</h2>
            <div class="error" id="authError"></div>
            <div class="success" id="authSuccess"></div>
            
            <div class="form-group">
                <label>‰ΩøÁî®ËÄÖ ID</label>
                <input type="text" id="userId" placeholder="Ëº∏ÂÖ•‰ΩøÁî®ËÄÖ ID">
            </div>
            
            <div class="form-group">
                <label>ÂØÜÁ¢º</label>
                <input type="password" id="password" placeholder="Ëº∏ÂÖ•ÂØÜÁ¢ºÔºàËá≥Â∞ë6ÂÄãÂ≠óÂÖÉÔºâ">
            </div>
            
            <div class="button-group">
                <button id="loginBtn">üîë ÁôªÂÖ•</button>
                <button id="registerBtn">‚ú® Ë®ªÂÜä</button>
            </div>
        </div>

        <!-- ‰∏ªÈù¢Êùø -->
        <div id="mainPanel" class="main-panel">
            <div class="user-info">
                <p>Ê≠°ËøéÔºå<span id="currentUser"></span> <span id="adminBadge"></span></p>
                <button class="logout-btn" id="logoutBtn">üö™ ÁôªÂá∫</button>
            </div>

            <div class="main-content">
                <div class="left-panel">
                    <div class="search-box">
                        <div class="search-form">
                            <input type="text" id="stockCode" placeholder="Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Á¢ºÔºà‰æãÂ¶ÇÔºö2330Ôºâ">
                            <button id="searchBtn">üîç Êü•Ë©¢</button>
                        </div>
                    </div>

                    <div id="resultPanel" class="result-panel" style="display: none;">
                        <h2 id="stockTitle"></h2>
                        
                        <div class="stock-info" id="stockInfo"></div>

                        <div class="tabs">
                            <div class="tab active" data-tab="kline">KÁ∑öÂúñ</div>
                            <div class="tab" data-tab="ma">ÊäÄË°ìÊåáÊ®ô</div>
                            <div class="tab" data-tab="volume">Êàê‰∫§Èáè</div>
                        </div>

                        <div id="kline" class="tab-content active">
                            <div id="klineChart" class="chart-container"></div>
                        </div>

                        <div id="ma" class="tab-content">
                            <div class="tech-indicators" id="techIndicators"></div>
                            <div id="maChart" class="chart-container"></div>
                        </div>

                        <div id="volume" class="tab-content">
                            <div id="volumeChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="favorites-panel">
                        <div class="favorites-header">
                            <h3>‚≠ê ÈóúÊ≥®Ê∏ÖÂñÆ</h3>
                            <button class="add-btn" id="toggleAddBtn">+ Êñ∞Â¢û</button>
                        </div>

                        <div class="add-favorite-form" id="addFavoriteForm">
                            <input type="text" id="newStockCode" placeholder="Ëº∏ÂÖ•ËÇ°Á•®‰ª£Á¢º">
                            <button id="confirmAddBtn">Á¢∫Ë™çÊñ∞Â¢û</button>
                        </div>

                        <div class="favorites-list-panel" id="favoritesListPanel">
                            <div class="loading">ËºâÂÖ•‰∏≠...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Áï∂ÂâçÁôªÂÖ•ÁãÄÊÖã
        let currentSession = {
            userId: null,
            isAdmin: false
        };

        let currentStockCode = null;
        let currentStockData = null;

        // ÁôªÂÖ•
        async function handleLogin() {
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            if (!userId || !password) {
                errorDiv.textContent = 'Ë´ãËº∏ÂÖ•‰ΩøÁî®ËÄÖ ID ÂíåÂØÜÁ¢º';
                errorDiv.classList.add('show');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                    successDiv.textContent = 'ÁôªÂÖ•ÊàêÂäüÔºÅ';
                    successDiv.classList.add('show');
                    
                    setTimeout(() => {
                        showMainPanel();
                        loadFavorites();
                    }, 500);
                } else {
                    errorDiv.textContent = data.message || 'ÁôªÂÖ•Â§±Êïó';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'ÁôªÂÖ•Âá∫ÈåØÔºö' + error.message;
                errorDiv.classList.add('show');
            }
        }

        // Ë®ªÂÜä
        async function handleRegister() {
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            if (!userId || !password) {
                errorDiv.textContent = 'Ë´ãËº∏ÂÖ•‰ΩøÁî®ËÄÖ ID ÂíåÂØÜÁ¢º';
                errorDiv.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'ÂØÜÁ¢ºËá≥Â∞ëÈúÄË¶Å6ÂÄãÂ≠óÂÖÉ';
                errorDiv.classList.add('show');
                return;
            }

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    successDiv.textContent = 'Ë®ªÂÜäÊàêÂäüÔºÅÊ≠£Âú®ÁôªÂÖ•...';
                    successDiv.classList.add('show');
                    
                    setTimeout(() => {
                        currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                        showMainPanel();
                        loadFavorites();
                    }, 500);
                } else {
                    errorDiv.textContent = data.message || 'Ë®ªÂÜäÂ§±Êïó';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Ë®ªÂÜäÂá∫ÈåØÔºö' + error.message;
                errorDiv.classList.add('show');
            }
        }

        // ÁôªÂá∫
        function handleLogout() {
            currentSession = { userId: null, isAdmin: false };
            currentStockCode = null;
            currentStockData = null;
            document.getElementById('authPanel').style.display = 'block';
            document.getElementById('mainPanel').classList.remove('show');
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('resultPanel').style.display = 'none';
        }

        // È°ØÁ§∫‰∏ªÈù¢Êùø
        function showMainPanel() {
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('mainPanel').classList.add('show');
            document.getElementById('currentUser').textContent = currentSession.userId;
            if (currentSession.isAdmin) {
                document.getElementById('adminBadge').textContent = 'üëë ÁÆ°ÁêÜÂì°';
            }
        }

        // Êü•Ë©¢ËÇ°Á•®
        async function searchStock() {
            const stockCode = document.getElementById('stockCode').value.trim();
            
            if (!stockCode) {
                alert('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Á¢º');
                return;
            }

            currentStockCode = stockCode;
            
            try {
                const response = await fetch(`/api/stock/${stockCode}`);
                const data = await response.json();

                if (data.success) {
                    currentStockData = data;
                    displayStockData(data);
                    document.getElementById('addFavoriteBtn').style.display = 'block';
                } else {
                    alert(data.message || 'Êü•Ë©¢Â§±Êïó');
                }
            } catch (error) {
                alert('Êü•Ë©¢Âá∫ÈåØÔºö' + error.message);
            }
        }

        // È°ØÁ§∫ËÇ°Á•®Êï∏Êìö
        function displayStockData(data) {
            const resultPanel = document.getElementById('resultPanel');
            const stockTitle = document.getElementById('stockTitle');
            const stockInfo = document.getElementById('stockInfo');

            stockTitle.textContent = `${data.stock_code} - ${data.stock_name}`;
            
            const changeClass = parseFloat(data.change) >= 0 ? 'positive' : 'negative';
            
            stockInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">ÁèæÂÉπ</div>
                    <div class="info-value ${changeClass}">${data.current_price}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Êº≤Ë∑å</div>
                    <div class="info-value ${changeClass}">${data.change}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÈñãÁõ§</div>
                    <div class="info-value">${data.open}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÊúÄÈ´ò</div>
                    <div class="info-value">${data.high}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÊúÄ‰Ωé</div>
                    <div class="info-value">${data.low}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Êàê‰∫§Èáè</div>
                    <div class="info-value">${data.volume}</div>
                </div>
            `;

            resultPanel.style.display = 'block';

            // Áπ™Ë£ΩÂúñË°®
            if (data.kline_data && data.kline_data.length > 0) {
                renderKlineChart(data.kline_data, data.stock_name);
                renderVolumeChart(data.kline_data, data.stock_name);
            }

            // È°ØÁ§∫ÊäÄË°ìÊåáÊ®ô
            if (data.technical_indicators) {
                displayTechnicalIndicators(data.technical_indicators);
                renderMAChart(data.kline_data, data.technical_indicators, data.stock_name);
            }
        }

        // Áπ™Ë£Ω K Á∑öÂúñ
        function renderKlineChart(klineData, stockName) {
            const chartDom = document.getElementById('klineChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            const candlestickData = klineData.map(item => [item[1], item[4], item[3], item[2]]);
            
            const ma5 = calculateMA(5, candlestickData);
            const ma10 = calculateMA(10, candlestickData);
            const ma20 = calculateMA(20, candlestickData);
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} KÁ∑öÂúñ`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                legend: {
                    data: ['KÁ∑ö', 'MA5', 'MA10', 'MA20'],
                    top: 30,
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: false },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    scale: true,
                    splitArea: { show: true },
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'KÁ∑ö',
                        type: 'candlestick',
                        data: candlestickData,
                        itemStyle: {
                            color: '#ef5350',
                            color0: '#26a69a',
                            borderColor: '#ef5350',
                            borderColor0: '#26a69a'
                        }
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma5,
                        smooth: true,
                        lineStyle: { width: 1, color: '#FFA500' },
                        showSymbol: false
                    },
                    {
                        name: 'MA10',
                        type: 'line',
                        data: ma10,
                        smooth: true,
                        lineStyle: { width: 1, color: '#00CED1' },
                        showSymbol: false
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma20,
                        smooth: true,
                        lineStyle: { width: 1, color: '#9370DB' },
                        showSymbol: false
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // Áπ™Ë£ΩÊàê‰∫§ÈáèÂúñ
        function renderVolumeChart(klineData, stockName) {
            const chartDom = document.getElementById('volumeChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            const volumes = klineData.map(item => item[5]);
            const candlestickData = klineData.map(item => [item[1], item[4], item[3], item[2]]);
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} Êàê‰∫§Èáè`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'Êàê‰∫§Èáè',
                        type: 'bar',
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                return candlestickData[dataIndex][0] > candlestickData[dataIndex][1] 
                                    ? '#26a69a' : '#ef5350';
                            }
                        }
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // È°ØÁ§∫ÊäÄË°ìÊåáÊ®ô
        function displayTechnicalIndicators(indicators) {
            const techIndicators = document.getElementById('techIndicators');
            
            let html = '';
            
            if (indicators.RSI) {
                const rsiClass = indicators.RSI < 30 ? 'positive' : (indicators.RSI > 70 ? 'negative' : '');
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">RSI (14)</div>
                        <div class="indicator-value ${rsiClass}">${indicators.RSI.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.MACD) {
                const macdClass = indicators.MACD > 0 ? 'positive' : 'negative';
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">MACD</div>
                        <div class="indicator-value ${macdClass}">${indicators.MACD.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.KD_K) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">KD KÂÄº</div>
                        <div class="indicator-value">${indicators.KD_K.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.KD_D) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">KD DÂÄº</div>
                        <div class="indicator-value">${indicators.KD_D.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.BB_UPPER) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÉÊûó‰∏äËªå</div>
                        <div class="indicator-value">${indicators.BB_UPPER.toFixed(2)}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÉÊûó‰∏≠Ëªå</div>
                        <div class="indicator-value">${indicators.BB_MIDDLE.toFixed(2)}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">Â∏ÉÊûó‰∏ãËªå</div>
                        <div class="indicator-value">${indicators.BB_LOWER.toFixed(2)}</div>
                    </div>
                `;
            }
            
            techIndicators.innerHTML = html;
        }

        // Áπ™Ë£ΩÊäÄË°ìÊåáÊ®ôÂúñ
        function renderMAChart(klineData, indicators, stockName) {
            const chartDom = document.getElementById('maChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            
            // ÈÄôË£°ÂèØ‰ª•Êì¥Â±ïÁπ™Ë£Ω MACD„ÄÅRSI Á≠âÊåáÊ®ôÁöÑÂúñË°®
            // Á∞°ÂåñÁâàÊú¨ÂÖàÈ°ØÁ§∫Âü∫Êú¨Ë≥áË®ä
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} ÊäÄË°ìÊåáÊ®ô`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                legend: {
                    data: ['RSI'],
                    top: 30,
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: Array(dates.length).fill(indicators.RSI || 50),
                        smooth: true,
                        lineStyle: { width: 2, color: '#FFA500' }
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // Ë®àÁÆóÁßªÂãïÂπ≥ÂùáÁ∑ö
        function calculateMA(dayCount, data) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < dayCount - 1) {
                    result.push('-');
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < dayCount; j++) {
                    sum += data[i - j][1];
                }
                result.push((sum / dayCount).toFixed(2));
            }
            return result;
        }

        // ËºâÂÖ•ÈóúÊ≥®ËÇ°Á•®
        async function loadFavorites() {
            try {
                const response = await fetch(`/api/favorites?user_id=${currentSession.userId}`);
                const data = await response.json();
                
                const favoritesListPanel = document.getElementById('favoritesListPanel');
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    favoritesListPanel.innerHTML = data.favorites.map(fav => `
                        <div class="favorite-item-panel">
                            <div class="favorite-info" onclick="quickSearch('${fav.stock_code}')">
                                <div class="favorite-code">${fav.stock_code}</div>
                                <div class="favorite-name">${fav.stock_name || 'Êü•Ë©¢‰∏≠...'}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteFavorite('${fav.stock_code}')">Âà™Èô§</button>
                        </div>
                    `).join('');
                } else {
                    favoritesListPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Â∞öÁÑ°ÈóúÊ≥®ËÇ°Á•®</div>';
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÈóúÊ≥®ËÇ°Á•®Â§±ÊïóÔºö', error);
                document.getElementById('favoritesListPanel').innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">ËºâÂÖ•Â§±Êïó</div>';
            }
        }

        // Âø´ÈÄüÊü•Ë©¢
        function quickSearch(stockCode) {
            document.getElementById('stockCode').value = stockCode;
            searchStock();
        }

        // ÂàáÊèõÊñ∞Â¢ûË°®ÂñÆ
        function toggleAddForm() {
            const form = document.getElementById('addFavoriteForm');
            form.classList.toggle('show');
            if (form.classList.contains('show')) {
                document.getElementById('newStockCode').focus();
            }
        }

        // Êñ∞Â¢ûÈóúÊ≥®
        async function addFavoriteNew() {
            const stockCode = document.getElementById('newStockCode').value.trim();
            
            if (!stockCode) {
                alert('Ë´ãËº∏ÂÖ•ËÇ°Á•®‰ª£Á¢º');
                return;
            }
            
            try {
                const response = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentSession.userId,
                        stock_code: stockCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('newStockCode').value = '';
                    document.getElementById('addFavoriteForm').classList.remove('show');
                    loadFavorites();
                } else {
                    alert(data.message || 'Âä†ÂÖ•ÈóúÊ≥®Â§±Êïó');
                }
            } catch (error) {
                alert('Âä†ÂÖ•ÈóúÊ≥®Âá∫ÈåØÔºö' + error.message);
            }
        }

        // Âà™Èô§ÈóúÊ≥®
        async function deleteFavorite(stockCode) {
            if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${stockCode} ÂóéÔºü`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/favorites/${stockCode}?user_id=${currentSession.userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadFavorites();
                } else {
                    alert(data.message || 'Âà™Èô§Â§±Êïó');
                }
            } catch (error) {
                alert('Âà™Èô§Âá∫ÈåØÔºö' + error.message);
            }
        }

        // ÂàáÊèõÊ®ôÁ±§
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÁôªÂÖ•ÊåâÈàï
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Êü•Ë©¢ÊåâÈàï
            document.getElementById('searchBtn').addEventListener('click', searchStock);
            
            // ÈóúÊ≥®Ê∏ÖÂñÆÊåâÈàï
            document.getElementById('toggleAddBtn').addEventListener('click', toggleAddForm);
            document.getElementById('confirmAddBtn').addEventListener('click', addFavoriteNew);
            
            // Enter ÈçµÁôªÂÖ•
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Enter ÈçµÊü•Ë©¢
            document.getElementById('stockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
            
            // Enter ÈçµÊñ∞Â¢ûÈóúÊ≥®
            document.getElementById('newStockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addFavoriteNew();
            });
            
            // Ê®ôÁ±§ÂàáÊèõ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
        });
    </script>
</body>
</html>
