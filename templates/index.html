<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§é¸è‚¡é«˜æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e0e0e0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .app-version {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }

        .auth-panel {
            background: #252538;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            max-width: 400px;
            margin: 0 auto 20px;
            border: 1px solid #3a3a52;
        }

        .auth-panel h2 {
            margin-bottom: 20px;
            color: #c0c0c0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
        }

        .form-group input:focus {
            border-color: #5a7fc7;
            box-shadow: 0 0 0 3px rgba(90, 127, 199, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(90, 127, 199, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        .main-panel {
            display: none;
        }

        .main-panel.show {
            display: block;
        }

        .search-box {
            background: #1e1e2e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            margin-bottom: 30px;
            border: 1px solid #2d2d44;
        }

        .user-info {
            background: #252538;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #3a3a52;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info span {
            font-weight: bold;
            color: #5a7fc7;
        }

        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            padding: 8px 20px;
            width: auto;
        }

        .search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid #3a3a52;
            border-radius: 8px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
        }

        .search-form input:focus {
            border-color: #5a7fc7;
        }

        .search-form button {
            padding: 12px 30px;
            white-space: nowrap;
        }

        .result-panel {
            background: #252538;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3a3a52;
            margin-top: 20px;
        }

        .stock-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
        }

        .positive {
            color: #26a69a;
        }

        .negative {
            color: #ef5350;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            background: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #3a3a52;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a52;
            padding-bottom: 10px;
        }

        .tab {
            padding: 8px 16px;
            background: #252538;
            border: 1px solid #3a3a52;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4a6fa5;
            border-bottom-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error {
            background: #c0392b;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .favorites-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .favorite-item {
            background: #1a1a2e;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorite-item:hover {
            background: #4a6fa5;
        }

        .tech-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .indicator-item {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .indicator-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 3px;
        }

        .indicator-value {
            font-size: 14px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .left-panel {
            min-width: 0;
        }

        .right-panel {
            background: #1e1e2e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 1px solid #2d2d44;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .favorites-panel h3 {
            margin-bottom: 15px;
            color: #5a7fc7;
            font-size: 1.2em;
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-favorite-form {
            display: none;
            background: #252538;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #3a3a52;
        }

        .add-favorite-form.show {
            display: block;
        }

        .add-favorite-form input {
            width: 100%;
            padding: 8px;
            border: 2px solid #3a3a52;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1a2e;
            color: #e0e0e0;
            outline: none;
            margin-bottom: 10px;
        }

        .add-favorite-form button {
            width: 100%;
            padding: 8px;
            font-size: 14px;
        }

        .favorites-list-panel {
            max-height: 500px;
            overflow-y: auto;
        }

        .favorite-item-panel {
            background: #252538;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #3a3a52;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .favorite-item-panel:hover {
            background: #2d2d44;
            transform: translateX(-2px);
        }

        .favorite-info {
            flex: 1;
            cursor: pointer;
        }

        .favorite-code {
            font-weight: bold;
            color: #5a7fc7;
            font-size: 14px;
        }

        .favorite-name {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #229954;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .right-panel {
                position: relative;
                top: 0;
            }
        }

        /* AI èŠå¤©æ¨£å¼ */
        .ai-chat-container {
            background: #252538;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #3a3a52;
            overflow: hidden;
        }

        .ai-chat-header {
            background: #1a1a2e;
            padding: 12px 15px;
            border-bottom: 1px solid #3a3a52;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h4 {
            color: #5a7fc7;
            font-size: 14px;
            margin: 0;
        }

        .ai-provider-select {
            background: #1e1e2e;
            border: 1px solid #3a3a52;
            color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .ai-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #1a1a2e;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.5;
            font-size: 13px;
        }

        .ai-message.user {
            background: #4a6fa5;
            color: white;
            margin-left: 30px;
        }

        .ai-message.assistant {
            background: #252538;
            color: #e0e0e0;
            margin-right: 30px;
            border: 1px solid #3a3a52;
        }

        .ai-message.system {
            background: #e74c3c;
            color: white;
            text-align: center;
            margin: 0;
        }

        .ai-input-container {
            padding: 15px;
            background: #1e1e2e;
            border-top: 1px solid #3a3a52;
            display: flex;
            gap: 10px;
        }

        .ai-input {
            flex: 1;
            padding: 8px 12px;
            background: #252538;
            border: 1px solid #3a3a52;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 13px;
            outline: none;
        }

        .ai-input:focus {
            border-color: #5a7fc7;
        }

        .ai-send-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #4a6fa5 0%, #5a7fc7 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .ai-send-btn:hover {
            transform: translateY(-1px);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“ˆ AI æ™ºæ…§é¸è‚¡é«˜æ‰‹</h1>
                <p class="app-version">v3.0 - æŠ€è¡“åˆ†æå°ˆæ¥­ç‰ˆ</p>
            </div>
            <a href="/settings" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âš™ï¸ è¨­ç½®</a>
        </div>

        <!-- ç™»å…¥é¢æ¿ -->
        <div id="authPanel" class="auth-panel">
            <h2>ğŸ” ç™»å…¥ / è¨»å†Š</h2>
            <div class="error" id="authError"></div>
            <div class="success" id="authSuccess"></div>
            
            <div class="form-group">
                <label>ä½¿ç”¨è€… ID</label>
                <input type="text" id="userId" placeholder="è¼¸å…¥ä½¿ç”¨è€… ID">
            </div>
            
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘6å€‹å­—å…ƒï¼‰">
            </div>
            
            <div class="button-group">
                <button id="loginBtn">ğŸ”‘ ç™»å…¥</button>
                <button id="registerBtn">âœ¨ è¨»å†Š</button>
            </div>
        </div>

        <!-- ä¸»é¢æ¿ -->
        <div id="mainPanel" class="main-panel">
            <div class="user-info">
                <p>æ­¡è¿ï¼Œ<span id="currentUser"></span> <span id="adminBadge"></span></p>
                <button class="logout-btn" id="logoutBtn">ğŸšª ç™»å‡º</button>
            </div>

            <div class="main-content">
                <div class="left-panel">
                    <div class="search-box">
                        <div class="search-form">
                            <input type="text" id="stockCode" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330ï¼‰">
                            <button id="searchBtn">ğŸ” æŸ¥è©¢</button>
                        </div>
                    </div>

                    <div id="resultPanel" class="result-panel" style="display: none;">
                        <h2 id="stockTitle"></h2>
                        
                        <div class="stock-info" id="stockInfo"></div>

                        <div class="tabs">
                            <div class="tab active" data-tab="kline">Kç·šåœ–</div>
                            <div class="tab" data-tab="ma">æŠ€è¡“æŒ‡æ¨™</div>
                            <div class="tab" data-tab="volume">æˆäº¤é‡</div>
                        </div>

                        <div id="kline" class="tab-content active">
                            <div id="klineChart" class="chart-container"></div>
                        </div>

                        <div id="ma" class="tab-content">
                            <div class="tech-indicators" id="techIndicators"></div>
                            <div id="maChart" class="chart-container"></div>
                        </div>

                        <div id="volume" class="tab-content">
                            <div id="volumeChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="favorites-panel">
                        <div class="favorites-header">
                            <h3>â­ é—œæ³¨æ¸…å–®</h3>
                            <button class="add-btn" id="toggleAddBtn">+ æ–°å¢</button>
                        </div>

                        <div class="add-favorite-form" id="addFavoriteForm">
                            <input type="text" id="newStockCode" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼">
                            <button id="confirmAddBtn">ç¢ºèªæ–°å¢</button>
                        </div>

                        <div class="favorites-list-panel" id="favoritesListPanel">
                            <div class="loading">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>

                    <!-- AI åŠ©æ‰‹ -->
                    <div class="ai-chat-container">
                        <div class="ai-chat-header">
                            <h4>ğŸ¤– AI æŠ•è³‡åŠ©æ‰‹</h4>
                            <select class="ai-provider-select" id="aiProvider">
                                <option value="openai">OpenAI GPT</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="ai-messages" id="aiMessages">
                            <div class="ai-message assistant">
                                å—¨ï¼æˆ‘æ˜¯æ‚¨çš„AIæŠ•è³‡åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥å•æˆ‘é—œæ–¼è‚¡ç¥¨åˆ†æã€æŠ€è¡“æŒ‡æ¨™ã€æŠ•è³‡ç­–ç•¥ç­‰å•é¡Œã€‚
                            </div>
                        </div>
                        <div class="ai-input-container">
                            <input type="text" class="ai-input" id="aiInput" placeholder="è©¢å•è‚¡ç¥¨å•é¡Œ...">
                            <button class="ai-send-btn" id="aiSendBtn">ç™¼é€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç•¶å‰ç™»å…¥ç‹€æ…‹
        let currentSession = {
            userId: null,
            isAdmin: false
        };

        let currentStockCode = null;
        let currentStockData = null;

        // ç™»å…¥
        async function handleLogin() {
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            if (!userId || !password) {
                errorDiv.textContent = 'è«‹è¼¸å…¥ä½¿ç”¨è€… ID å’Œå¯†ç¢¼';
                errorDiv.classList.add('show');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                    successDiv.textContent = 'ç™»å…¥æˆåŠŸï¼';
                    successDiv.classList.add('show');
                    
                    setTimeout(() => {
                        showMainPanel();
                        loadFavorites();
                    }, 500);
                } else {
                    errorDiv.textContent = data.message || 'ç™»å…¥å¤±æ•—';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'ç™»å…¥å‡ºéŒ¯ï¼š' + error.message;
                errorDiv.classList.add('show');
            }
        }

        // è¨»å†Š
        async function handleRegister() {
            const userId = document.getElementById('userId').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');

            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            if (!userId || !password) {
                errorDiv.textContent = 'è«‹è¼¸å…¥ä½¿ç”¨è€… ID å’Œå¯†ç¢¼';
                errorDiv.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—å…ƒ';
                errorDiv.classList.add('show');
                return;
            }

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });

                const data = await response.json();

                if (data.success) {
                    successDiv.textContent = 'è¨»å†ŠæˆåŠŸï¼æ­£åœ¨ç™»å…¥...';
                    successDiv.classList.add('show');
                    
                    setTimeout(() => {
                        currentSession = { userId: data.user_id, isAdmin: data.is_admin };
                        showMainPanel();
                        loadFavorites();
                    }, 500);
                } else {
                    errorDiv.textContent = data.message || 'è¨»å†Šå¤±æ•—';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'è¨»å†Šå‡ºéŒ¯ï¼š' + error.message;
                errorDiv.classList.add('show');
            }
        }

        // ç™»å‡º
        function handleLogout() {
            currentSession = { userId: null, isAdmin: false };
            currentStockCode = null;
            currentStockData = null;
            document.getElementById('authPanel').style.display = 'block';
            document.getElementById('mainPanel').classList.remove('show');
            document.getElementById('userId').value = '';
            document.getElementById('password').value = '';
            document.getElementById('resultPanel').style.display = 'none';
        }

        // é¡¯ç¤ºä¸»é¢æ¿
        function showMainPanel() {
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('mainPanel').classList.add('show');
            document.getElementById('currentUser').textContent = currentSession.userId;
            if (currentSession.isAdmin) {
                document.getElementById('adminBadge').textContent = 'ğŸ‘‘ ç®¡ç†å“¡';
            }
        }

        // æŸ¥è©¢è‚¡ç¥¨
        async function searchStock() {
            const stockCode = document.getElementById('stockCode').value.trim();
            
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }

            currentStockCode = stockCode;
            
            try {
                const response = await fetch(`/api/stock/${stockCode}`);
                const data = await response.json();

                if (data.success) {
                    currentStockData = data;
                    displayStockData(data);
                    document.getElementById('addFavoriteBtn').style.display = 'block';
                    
                    // è‡ªå‹•è§¸ç™¼ AI åˆ†æ
                    autoAnalyzeStock(stockCode);
                } else {
                    alert(data.message || 'æŸ¥è©¢å¤±æ•—');
                }
            } catch (error) {
                alert('æŸ¥è©¢å‡ºéŒ¯ï¼š' + error.message);
            }
        }

        // è‡ªå‹•åˆ†æè‚¡ç¥¨
        async function autoAnalyzeStock(stockCode) {
            const messagesDiv = document.getElementById('aiMessages');
            
            // é¡¯ç¤ºåˆ†æä¸­è¨Šæ¯
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'ai-message assistant';
            loadingMsg.innerHTML = 'â³ æ­£åœ¨åˆ†æè‚¡ç¥¨æ•¸æ“šï¼Œè«‹ç¨å€™...';
            messagesDiv.appendChild(loadingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                const response = await fetch(`/api/analyze/stock/${stockCode}`);
                const result = await response.json();
                
                // ç§»é™¤è¼‰å…¥è¨Šæ¯
                messagesDiv.removeChild(loadingMsg);
                
                if (result.success) {
                    const analysis = result.analysis;
                    
                    // é¡¯ç¤ºåˆ†æçµæœ
                    const analysisMsg = document.createElement('div');
                    analysisMsg.className = 'ai-message assistant';
                    analysisMsg.innerHTML = `
                        <strong>ğŸ“Š ${analysis.stock_code} - ${analysis.stock_name} å®Œæ•´åˆ†æ</strong><br><br>
                        
                        <strong>ğŸ’° åƒ¹æ ¼åˆ†æï¼š</strong><br>
                        ç•¶å‰åƒ¹æ ¼ï¼š${analysis.current_price.toFixed(2)} å…ƒ<br>
                        å¹´åº¦é«˜é»ï¼š${analysis.year_high.toFixed(2)} å…ƒ<br>
                        å¹´åº¦ä½é»ï¼š${analysis.year_low.toFixed(2)} å…ƒ<br>
                        åƒ¹æ ¼ä½ç½®ï¼š${analysis.price_position}%<br><br>
                        
                        ${analysis.news && analysis.news.length > 0 ? `
                        <strong>ğŸ“° æœ€æ–°æ–°èï¼š</strong><br>
                        ${analysis.news.map(n => `â€¢ ${n.title}`).join('<br>')}<br><br>
                        ` : ''}
                        
                        <strong>ğŸ¤– AI æŠ•è³‡å»ºè­°ï¼š</strong><br>
                        <div style="background: rgba(74, 111, 165, 0.2); padding: 10px; border-radius: 6px; margin-top: 8px; white-space: pre-wrap;">
                        ${analysis.ai_recommendation}
                        </div>
                    `;
                    messagesDiv.appendChild(analysisMsg);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'ai-message assistant';
                    errorMsg.textContent = 'âŒ ' + (result.message || 'åˆ†æå¤±æ•—');
                    messagesDiv.appendChild(errorMsg);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            } catch (error) {
                messagesDiv.removeChild(loadingMsg);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-message assistant';
                errorMsg.textContent = 'âŒ åˆ†æå‡ºéŒ¯ï¼š' + error.message;
                messagesDiv.appendChild(errorMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // é¡¯ç¤ºè‚¡ç¥¨æ•¸æ“š
        function displayStockData(data) {
            const resultPanel = document.getElementById('resultPanel');
            const stockTitle = document.getElementById('stockTitle');
            const stockInfo = document.getElementById('stockInfo');

            stockTitle.textContent = `${data.stock_code} - ${data.stock_name}`;
            
            const changeClass = parseFloat(data.change) >= 0 ? 'positive' : 'negative';
            
            stockInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">ç¾åƒ¹</div>
                    <div class="info-value ${changeClass}">${data.current_price}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¼²è·Œ</div>
                    <div class="info-value ${changeClass}">${data.change}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">é–‹ç›¤</div>
                    <div class="info-value">${data.open}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœ€é«˜</div>
                    <div class="info-value">${data.high}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœ€ä½</div>
                    <div class="info-value">${data.low}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æˆäº¤é‡</div>
                    <div class="info-value">${data.volume}</div>
                </div>
            `;

            resultPanel.style.display = 'block';

            // ç¹ªè£½åœ–è¡¨
            if (data.kline_data && data.kline_data.length > 0) {
                renderKlineChart(data.kline_data, data.stock_name);
                renderVolumeChart(data.kline_data, data.stock_name);
            }

            // é¡¯ç¤ºæŠ€è¡“æŒ‡æ¨™
            if (data.technical_indicators) {
                displayTechnicalIndicators(data.technical_indicators);
                renderMAChart(data.kline_data, data.technical_indicators, data.stock_name);
            }
        }

        // ç¹ªè£½ K ç·šåœ–
        function renderKlineChart(klineData, stockName) {
            const chartDom = document.getElementById('klineChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            const candlestickData = klineData.map(item => [item[1], item[4], item[3], item[2]]);
            
            const ma5 = calculateMA(5, candlestickData);
            const ma10 = calculateMA(10, candlestickData);
            const ma20 = calculateMA(20, candlestickData);
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} Kç·šåœ–`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                legend: {
                    data: ['Kç·š', 'MA5', 'MA10', 'MA20'],
                    top: 30,
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: false },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    scale: true,
                    splitArea: { show: true },
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'Kç·š',
                        type: 'candlestick',
                        data: candlestickData,
                        itemStyle: {
                            color: '#ef5350',
                            color0: '#26a69a',
                            borderColor: '#ef5350',
                            borderColor0: '#26a69a'
                        }
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma5,
                        smooth: true,
                        lineStyle: { width: 1, color: '#FFA500' },
                        showSymbol: false
                    },
                    {
                        name: 'MA10',
                        type: 'line',
                        data: ma10,
                        smooth: true,
                        lineStyle: { width: 1, color: '#00CED1' },
                        showSymbol: false
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma20,
                        smooth: true,
                        lineStyle: { width: 1, color: '#9370DB' },
                        showSymbol: false
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // ç¹ªè£½æˆäº¤é‡åœ–
        function renderVolumeChart(klineData, stockName) {
            const chartDom = document.getElementById('volumeChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            const volumes = klineData.map(item => item[5]);
            const candlestickData = klineData.map(item => [item[1], item[4], item[3], item[2]]);
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} æˆäº¤é‡`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volumes,
                        itemStyle: {
                            color: function(params) {
                                const dataIndex = params.dataIndex;
                                return candlestickData[dataIndex][0] > candlestickData[dataIndex][1] 
                                    ? '#26a69a' : '#ef5350';
                            }
                        }
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // é¡¯ç¤ºæŠ€è¡“æŒ‡æ¨™
        function displayTechnicalIndicators(indicators) {
            const techIndicators = document.getElementById('techIndicators');
            
            let html = '';
            
            if (indicators.RSI) {
                const rsiClass = indicators.RSI < 30 ? 'positive' : (indicators.RSI > 70 ? 'negative' : '');
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">RSI (14)</div>
                        <div class="indicator-value ${rsiClass}">${indicators.RSI.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.MACD) {
                const macdClass = indicators.MACD > 0 ? 'positive' : 'negative';
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">MACD</div>
                        <div class="indicator-value ${macdClass}">${indicators.MACD.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.KD_K) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">KD Kå€¼</div>
                        <div class="indicator-value">${indicators.KD_K.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.KD_D) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">KD Då€¼</div>
                        <div class="indicator-value">${indicators.KD_D.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (indicators.BB_UPPER) {
                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">å¸ƒæ—ä¸Šè»Œ</div>
                        <div class="indicator-value">${indicators.BB_UPPER.toFixed(2)}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸ƒæ—ä¸­è»Œ</div>
                        <div class="indicator-value">${indicators.BB_MIDDLE.toFixed(2)}</div>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-label">å¸ƒæ—ä¸‹è»Œ</div>
                        <div class="indicator-value">${indicators.BB_LOWER.toFixed(2)}</div>
                    </div>
                `;
            }
            
            techIndicators.innerHTML = html;
        }

        // ç¹ªè£½æŠ€è¡“æŒ‡æ¨™åœ–
        function renderMAChart(klineData, indicators, stockName) {
            const chartDom = document.getElementById('maChart');
            const myChart = echarts.init(chartDom);
            
            const dates = klineData.map(item => item[0]);
            
            // é€™è£¡å¯ä»¥æ“´å±•ç¹ªè£½ MACDã€RSI ç­‰æŒ‡æ¨™çš„åœ–è¡¨
            // ç°¡åŒ–ç‰ˆæœ¬å…ˆé¡¯ç¤ºåŸºæœ¬è³‡è¨Š
            
            const option = {
                backgroundColor: '#1a1a2e',
                title: {
                    text: `${stockName} æŠ€è¡“æŒ‡æ¨™`,
                    left: 'center',
                    textStyle: { color: '#e0e0e0' }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(50, 50, 50, 0.9)',
                    borderColor: '#777',
                    textStyle: { color: '#e0e0e0' }
                },
                legend: {
                    data: ['RSI'],
                    top: 30,
                    textStyle: { color: '#e0e0e0' }
                },
                grid: {
                    left: '10%',
                    right: '8%',
                    top: '20%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { color: '#e0e0e0' }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLabel: { color: '#e0e0e0' },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { lineStyle: { color: '#2d2d44' } }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100,
                        textStyle: { color: '#e0e0e0' }
                    }
                ],
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: Array(dates.length).fill(indicators.RSI || 50),
                        smooth: true,
                        lineStyle: { width: 2, color: '#FFA500' }
                    }
                ]
            };
            
            myChart.setOption(option);
            
            window.addEventListener('resize', function() {
                myChart.resize();
            });
        }

        // è¨ˆç®—ç§»å‹•å¹³å‡ç·š
        function calculateMA(dayCount, data) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < dayCount - 1) {
                    result.push('-');
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < dayCount; j++) {
                    sum += data[i - j][1];
                }
                result.push((sum / dayCount).toFixed(2));
            }
            return result;
        }

        // è¼‰å…¥é—œæ³¨è‚¡ç¥¨
        async function loadFavorites() {
            try {
                const response = await fetch(`/api/favorites?user_id=${currentSession.userId}`);
                const data = await response.json();
                
                const favoritesListPanel = document.getElementById('favoritesListPanel');
                
                if (data.success && data.favorites && data.favorites.length > 0) {
                    favoritesListPanel.innerHTML = data.favorites.map(fav => `
                        <div class="favorite-item-panel">
                            <div class="favorite-info" onclick="quickSearch('${fav.stock_code}')">
                                <div class="favorite-code">${fav.stock_code}</div>
                                <div class="favorite-name">${fav.stock_name || 'æŸ¥è©¢ä¸­...'}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteFavorite('${fav.stock_code}')">åˆªé™¤</button>
                        </div>
                    `).join('');
                } else {
                    favoritesListPanel.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">å°šç„¡é—œæ³¨è‚¡ç¥¨</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥é—œæ³¨è‚¡ç¥¨å¤±æ•—ï¼š', error);
                document.getElementById('favoritesListPanel').innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 20px;">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // å¿«é€ŸæŸ¥è©¢
        function quickSearch(stockCode) {
            document.getElementById('stockCode').value = stockCode;
            searchStock();
        }

        // åˆ‡æ›æ–°å¢è¡¨å–®
        function toggleAddForm() {
            const form = document.getElementById('addFavoriteForm');
            form.classList.toggle('show');
            if (form.classList.contains('show')) {
                document.getElementById('newStockCode').focus();
            }
        }

        // æ–°å¢é—œæ³¨
        async function addFavoriteNew() {
            const stockCode = document.getElementById('newStockCode').value.trim();
            
            if (!stockCode) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            try {
                const response = await fetch('/api/favorites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentSession.userId,
                        stock_code: stockCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('newStockCode').value = '';
                    document.getElementById('addFavoriteForm').classList.remove('show');
                    loadFavorites();
                } else {
                    alert(data.message || 'åŠ å…¥é—œæ³¨å¤±æ•—');
                }
            } catch (error) {
                alert('åŠ å…¥é—œæ³¨å‡ºéŒ¯ï¼š' + error.message);
            }
        }

        // åˆªé™¤é—œæ³¨
        async function deleteFavorite(stockCode) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${stockCode} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/favorites/${stockCode}?user_id=${currentSession.userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadFavorites();
                } else {
                    alert(data.message || 'åˆªé™¤å¤±æ•—');
                }
            } catch (error) {
                alert('åˆªé™¤å‡ºéŒ¯ï¼š' + error.message);
            }
        }

        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // AI èŠå¤©åŠŸèƒ½
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            const provider = document.getElementById('aiProvider').value;
            const sendBtn = document.getElementById('aiSendBtn');
            const messagesContainer = document.getElementById('aiMessages');
            
            if (!message) return;
            
            // æ·»åŠ ä½¿ç”¨è€…è¨Šæ¯
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-message user';
            userMsg.textContent = message;
            messagesContainer.appendChild(userMsg);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            input.value = '';
            
            // ç¦ç”¨ç™¼é€æŒ‰éˆ•
            sendBtn.disabled = true;
            sendBtn.textContent = 'æ€è€ƒä¸­...';
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        provider: provider,
                        stock_context: currentStockData
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'ai-message assistant';
                    assistantMsg.textContent = data.reply;
                    messagesContainer.appendChild(assistantMsg);
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'ai-message system';
                    errorMsg.textContent = data.message || 'AI å›æ‡‰å¤±æ•—';
                    messagesContainer.appendChild(errorMsg);
                }
            } catch (error) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-message system';
                errorMsg.textContent = 'é€£æ¥å¤±æ•—ï¼š' + error.message;
                messagesContainer.appendChild(errorMsg);
            } finally {
                // æ¢å¾©ç™¼é€æŒ‰éˆ•
                sendBtn.disabled = false;
                sendBtn.textContent = 'ç™¼é€';
                
                // æ»¾å‹•åˆ°åº•éƒ¨
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // è¼‰å…¥å¯ç”¨çš„ AI æä¾›è€…
        async function loadAIProviders() {
            try {
                const response = await fetch('/api/ai/providers');
                const data = await response.json();
                
                if (data.success && data.providers.length > 0) {
                    const select = document.getElementById('aiProvider');
                    select.innerHTML = data.providers.map(p => 
                        `<option value="${p.id}">${p.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥ AI æä¾›è€…å¤±æ•—ï¼š', error);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç™»å…¥æŒ‰éˆ•
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // æŸ¥è©¢æŒ‰éˆ•
            document.getElementById('searchBtn').addEventListener('click', searchStock);
            
            // é—œæ³¨æ¸…å–®æŒ‰éˆ•
            document.getElementById('toggleAddBtn').addEventListener('click', toggleAddForm);
            document.getElementById('confirmAddBtn').addEventListener('click', addFavoriteNew);
            
            // AI èŠå¤©æŒ‰éˆ•
            document.getElementById('aiSendBtn').addEventListener('click', sendAIMessage);
            
            // Enter éµç™»å…¥
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Enter éµæŸ¥è©¢
            document.getElementById('stockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
            
            // Enter éµæ–°å¢é—œæ³¨
            document.getElementById('newStockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addFavoriteNew();
            });
            
            // Enter éµç™¼é€ AI è¨Šæ¯
            document.getElementById('aiInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendAIMessage();
            });
            
            // æ¨™ç±¤åˆ‡æ›
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // è¼‰å…¥ AI æä¾›è€…
            loadAIProviders();
        });
    </script>
</body>
</html>
